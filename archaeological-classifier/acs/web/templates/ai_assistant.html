{% extends "base.html" %}

{% block title %}AI Assistant - Archaeological Classifier{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ü§ñ AI Classification Assistant</h1>
    <p>AI-powered analysis using Claude 4.5 Sonnet + Machine Learning</p>
</div>

<!-- Help Section -->
<div class="help-section card" style="background: #f8f9fa; border-left: 4px solid #007bff;">
    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
         onclick="toggleHelp()">
        <h3>‚ÑπÔ∏è How AI Classification Works</h3>
        <button type="button" class="btn btn-secondary" id="help-toggle-btn">
            ‚ñº Show Help
        </button>
    </div>
    <div id="help-content" style="display: none; line-height: 1.8; margin-top: 15px;">
        <p><strong>Overview:</strong> This system combines AI intelligence with machine learning to assist with archaeological artifact classification.</p>

        <h4>üß† AI Classification (Claude 4.5)</h4>
        <ul>
            <li><strong>What it does:</strong> Analyzes artifact features and provides intelligent classification suggestions with archaeological context</li>
            <li><strong>Requires:</strong> Anthropic API key (configure below)</li>
            <li><strong>Best for:</strong> Initial analysis, expert second opinion, or when dealing with unusual artifacts</li>
            <li><strong>Output:</strong> Detailed analysis with reasoning, suggested classifications, and confidence levels</li>
        </ul>

        <h4>üéì ML Prediction</h4>
        <ul>
            <li><strong>What it does:</strong> Uses trained Random Forest model to predict artifact class based on validated samples</li>
            <li><strong>Requires:</strong> At least 20 validated artifacts in the database</li>
            <li><strong>Best for:</strong> Fast, consistent classification once the model is trained</li>
            <li><strong>Output:</strong> Predicted class with confidence score and feature importance</li>
        </ul>

        <h4>‚ö° Hybrid Classification</h4>
        <ul>
            <li><strong>What it does:</strong> Combines rule-based taxonomy + ML for maximum reliability</li>
            <li><strong>Best for:</strong> Production use with high confidence requirements</li>
            <li><strong>Output:</strong> Compares both methods and highlights agreements/disagreements</li>
        </ul>

        <h4>üìö ML Training</h4>
        <ul>
            <li><strong>What it does:</strong> Trains the ML model on your validated artifact classifications</li>
            <li><strong>When to use:</strong> After adding new validated artifacts or when accuracy needs improvement</li>
            <li><strong>Process:</strong> Automatically splits data (80/20), trains model, reports accuracy metrics</li>
        </ul>
    </div>
</div>

<!-- API Key Configuration -->
<div class="api-key-section card">
    <h3>üîë API Key Configuration</h3>
    <p>Configure your Anthropic API key for AI-powered classification (required for AI features)</p>

    <div id="api-key-status" style="margin-bottom: 15px;">
        <p><strong>Status:</strong> <span id="key-status-badge">Checking...</span></p>
        <p id="masked-key-display" style="display:none;"><strong>Current Key:</strong> <code id="masked-key"></code></p>
    </div>

    <div class="form-group">
        <label for="api-key-input">Anthropic API Key:</label>
        <div style="display: flex; gap: 10px;">
            <input type="password" id="api-key-input" class="form-control"
                   placeholder="sk-ant-api03-..." style="flex: 1;">
            <button id="btn-toggle-key-visibility" class="btn btn-secondary" type="button">üëÅÔ∏è Show</button>
        </div>
        <small style="color: #666;">
            Get your API key from <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
        </small>
    </div>

    <div style="display: flex; gap: 10px;">
        <button id="btn-save-api-key" class="btn btn-primary">üíæ Save API Key</button>
        <button id="btn-delete-api-key" class="btn btn-danger" style="display:none;">üóëÔ∏è Delete Key</button>
    </div>

    <div id="api-key-message" style="margin-top: 10px; display:none;"></div>
</div>

<div class="ai-status card" id="ai-status">
    <h3>System Status</h3>
    <div id="status-indicators">
        <p><strong>AI (Claude 4.5):</strong> <span id="ai-status-badge">Checking...</span></p>
        <p><strong>ML Model:</strong> <span id="ml-status-badge">Checking...</span></p>
        <p><strong>Database:</strong> <span id="db-status-badge">Checking...</span></p>
    </div>
</div>

<div class="ai-container">
    <!-- AI Classification Section -->
    <div class="ai-section card">
        <h2>üß† AI Classification</h2>
        <p>Use Claude 4.5 to analyze artifacts and suggest classifications</p>

        <div class="form-group">
            <label for="ai-artifact-select">Select Artifact:</label>
            <select id="ai-artifact-select" class="form-control">
                <option value="">-- Select artifact --</option>
                {% for artifact_id in artifacts %}
                <option value="{{ artifact_id }}">{{ artifact_id }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="ai-context">Archaeological Context (optional):</label>
            <textarea id="ai-context" class="form-control" rows="3"
                      placeholder="E.g., Found in Savignano excavation, Bronze Age context..."></textarea>
        </div>

        <button id="btn-ai-classify" class="btn btn-primary">
            ü§ñ Analyze with AI
        </button>

        <div id="ai-results" class="results-section" style="display:none;">
            <h3>AI Analysis Results</h3>
            <div id="ai-results-content"></div>
        </div>
    </div>

    <!-- ML Prediction Section -->
    <div class="ai-section card">
        <h2>üéì Machine Learning Prediction</h2>
        <p>Use trained ML model to predict artifact class</p>

        <div class="form-group">
            <label for="ml-artifact-select">Select Artifact:</label>
            <select id="ml-artifact-select" class="form-control">
                <option value="">-- Select artifact --</option>
                {% for artifact_id in artifacts %}
                <option value="{{ artifact_id }}">{{ artifact_id }}</option>
                {% endfor %}
            </select>
        </div>

        <button id="btn-ml-predict" class="btn btn-primary">
            üéØ Predict with ML
        </button>

        <div id="ml-results" class="results-section" style="display:none;">
            <h3>ML Prediction Results</h3>
            <div id="ml-results-content"></div>
        </div>
    </div>

    <!-- Hybrid Classification Section -->
    <div class="ai-section card">
        <h2>‚ö° Hybrid Classification</h2>
        <p>Combine rule-based taxonomy + ML for maximum reliability</p>

        <div class="form-group">
            <label for="hybrid-artifact-select">Select Artifact:</label>
            <select id="hybrid-artifact-select" class="form-control">
                <option value="">-- Select artifact --</option>
                {% for artifact_id in artifacts %}
                <option value="{{ artifact_id }}">{{ artifact_id }}</option>
                {% endfor %}
            </select>
        </div>

        <button id="btn-hybrid-classify" class="btn btn-primary">
            ‚ö° Hybrid Classification
        </button>

        <div id="hybrid-results" class="results-section" style="display:none;">
            <h3>Hybrid Classification Results</h3>
            <div id="hybrid-results-content"></div>
        </div>
    </div>

    <!-- ML Training Section -->
    <div class="ai-section card">
        <h2>üéì Train ML Model</h2>
        <p>Train machine learning model with validated classifications</p>

        <div class="training-info" id="training-info">
            <p><strong>Training Samples:</strong> <span id="training-samples-count">Loading...</span></p>
            <p><strong>Model Status:</strong> <span id="model-status">Loading...</span></p>
        </div>

        <div class="form-group">
            <label for="ml-algorithm">Algorithm:</label>
            <select id="ml-algorithm" class="form-control">
                <option value="random_forest">Random Forest (recommended)</option>
                <option value="gradient_boosting">Gradient Boosting</option>
            </select>
        </div>

        <button id="btn-ml-train" class="btn btn-primary">
            üéì Train Model
        </button>

        <div id="training-results" class="results-section" style="display:none;">
            <h3>Training Results</h3>
            <div id="training-results-content"></div>
        </div>
    </div>

    <!-- Automatic Stylistic Classification Section -->
    <div class="ai-section card" style="grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h2 style="color: white;">üé® Automatic Stylistic Classification</h2>
        <p style="color: rgba(255,255,255,0.9);">Automatically classify ALL unclassified artifacts using combined stylistic, morphometric, AI, and ML analysis</p>

        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <h4 style="color: white; margin-top: 0;">How it works:</h4>
            <ul style="color: rgba(255,255,255,0.9); line-height: 1.8;">
                <li><strong>Morphometric Analysis:</strong> Extracts shape and dimensional features</li>
                <li><strong>Stylistic Analysis:</strong> Evaluates symmetry, proportions, surface quality</li>
                <li><strong>AI Classification:</strong> Uses Claude 4.5 for intelligent suggestions (if API key configured)</li>
                <li><strong>ML Prediction:</strong> Applies trained model (if available)</li>
                <li><strong>Confidence Threshold:</strong> Auto-saves classifications with >80% confidence</li>
            </ul>
        </div>

        <button id="btn-auto-classify" class="btn btn-primary" style="background: white; color: #667eea; font-weight: bold; font-size: 16px;">
            üöÄ Run Automatic Classification
        </button>

        <div id="auto-classify-results" class="results-section" style="display:none; background: rgba(255,255,255,0.95); color: #333; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h3 style="color: #667eea;">Classification Results</h3>
            <div id="auto-classify-results-content"></div>
        </div>
    </div>
</div>

<style>
.ai-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.ai-section {
    padding: 20px;
}

.ai-section h2 {
    color: #667eea;
    margin-bottom: 10px;
}

.ai-section p {
    color: #718096;
    font-size: 14px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #2d3748;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
}

textarea.form-control {
    resize: vertical;
    font-family: inherit;
}

.results-section {
    margin-top: 20px;
    padding: 15px;
    background: #f7fafc;
    border-radius: 4px;
    border-left: 4px solid #667eea;
}

.results-section h3 {
    margin: 0 0 15px 0;
    color: #2d3748;
    font-size: 16px;
}

#ai-results-content, #ml-results-content, #hybrid-results-content, #training-results-content {
    font-size: 14px;
    line-height: 1.6;
}

.result-item {
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e2e8f0;
}

.result-item:last-child {
    border-bottom: none;
}

.result-label {
    font-weight: 600;
    color: #4a5568;
}

.confidence-bar {
    height: 20px;
    background: #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 5px;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 600;
}

.ai-status {
    margin-bottom: 20px;
    padding: 15px;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
}

.status-active {
    background: #c6f6d5;
    color: #22543d;
}

.status-inactive {
    background: #fed7d7;
    color: #742a2a;
}

.status-warning {
    background: #feebc8;
    color: #7c2d12;
}

.training-info {
    padding: 12px;
    background: #edf2f7;
    border-radius: 4px;
    margin-bottom: 15px;
}

.training-info p {
    margin: 5px 0;
    color: #2d3748;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // Check API key status
    await checkAPIKeyStatus();

    // Check system status
    await checkSystemStatus();

    // API Key Management
    document.getElementById('btn-toggle-key-visibility').addEventListener('click', () => {
        const input = document.getElementById('api-key-input');
        const btn = document.getElementById('btn-toggle-key-visibility');
        if (input.type === 'password') {
            input.type = 'text';
            btn.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è Hide';
        } else {
            input.type = 'password';
            btn.textContent = 'üëÅÔ∏è Show';
        }
    });

    document.getElementById('btn-save-api-key').addEventListener('click', async () => {
        const apiKey = document.getElementById('api-key-input').value.trim();

        if (!apiKey) {
            showAPIKeyMessage('Please enter an API key', 'error');
            return;
        }

        const btn = document.getElementById('btn-save-api-key');
        btn.textContent = '‚è≥ Saving...';
        btn.disabled = true;

        try {
            const response = await fetch('/web/config/api-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey })
            });

            const data = await response.json();

            if (response.ok) {
                showAPIKeyMessage('‚úÖ API key saved successfully!', 'success');
                document.getElementById('api-key-input').value = '';
                await checkAPIKeyStatus();
                await checkSystemStatus(); // Refresh AI status
            } else {
                showAPIKeyMessage(`‚ùå Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showAPIKeyMessage(`‚ùå Error: ${error.message}`, 'error');
        } finally {
            btn.textContent = 'üíæ Save API Key';
            btn.disabled = false;
        }
    });

    document.getElementById('btn-delete-api-key').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete the stored API key?')) {
            return;
        }

        const btn = document.getElementById('btn-delete-api-key');
        btn.textContent = '‚è≥ Deleting...';
        btn.disabled = true;

        try {
            const response = await fetch('/web/config/api-key', {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                showAPIKeyMessage('‚úÖ API key deleted', 'success');
                await checkAPIKeyStatus();
                await checkSystemStatus();
            } else {
                showAPIKeyMessage(`‚ùå Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showAPIKeyMessage(`‚ùå Error: ${error.message}`, 'error');
        } finally {
            btn.textContent = 'üóëÔ∏è Delete Key';
            btn.disabled = false;
        }
    });

    // AI Classification
    document.getElementById('btn-ai-classify').addEventListener('click', async () => {
        const artifactId = document.getElementById('ai-artifact-select').value;
        const context = document.getElementById('ai-context').value;

        if (!artifactId) {
            alert('Please select an artifact');
            return;
        }

        const btn = document.getElementById('btn-ai-classify');
        btn.textContent = '‚è≥ Analyzing...';
        btn.disabled = true;

        // Show results container immediately with streaming indicator
        const resultsDiv = document.getElementById('ai-results');
        const resultsContent = document.getElementById('ai-results-content');
        resultsDiv.style.display = 'block';
        resultsContent.innerHTML = `
            <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; margin-bottom: 15px;">
                <strong>ü§ñ AI Analysis for ${artifactId}</strong>
                <div style="margin-top: 10px; color: #666;">
                    <em>Streaming response from Claude 4.5 Sonnet...</em>
                </div>
            </div>
            <div id="ai-stream-content" style="white-space: pre-wrap; line-height: 1.6; font-size: 14px;"></div>
        `;

        try {
            const response = await fetch('/web/ai-classify-stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ artifact_id: artifactId, context })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            const streamContent = document.getElementById('ai-stream-content');

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));

                        if (data.type === 'text') {
                            // Append text chunk in real-time
                            streamContent.textContent += data.content;
                        } else if (data.type === 'done') {
                            // Analysis complete
                            btn.textContent = '‚úì Analysis Complete!';
                            setTimeout(() => {
                                btn.textContent = 'ü§ñ Analyze with AI';
                                btn.disabled = false;
                            }, 2000);
                        } else if (data.type === 'error') {
                            alert(`Error: ${data.error}`);
                            btn.textContent = 'ü§ñ Analyze with AI';
                            btn.disabled = false;
                        }
                    }
                }
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
            btn.textContent = 'ü§ñ Analyze with AI';
            btn.disabled = false;
        }
    });

    // ML Prediction
    document.getElementById('btn-ml-predict').addEventListener('click', async () => {
        const artifactId = document.getElementById('ml-artifact-select').value;

        if (!artifactId) {
            alert('Please select an artifact');
            return;
        }

        const btn = document.getElementById('btn-ml-predict');
        btn.textContent = '‚è≥ Predicting...';
        btn.disabled = true;

        try {
            const response = await fetch('/web/ml-predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ artifact_id: artifactId })
            });

            const data = await response.json();

            if (response.ok) {
                displayMLResults(data);
            } else {
                alert(`Error: ${data.message || data.error || 'ML prediction failed'}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            btn.textContent = 'üéØ Predict with ML';
            btn.disabled = false;
        }
    });

    // Hybrid Classification
    document.getElementById('btn-hybrid-classify').addEventListener('click', async () => {
        const artifactId = document.getElementById('hybrid-artifact-select').value;

        if (!artifactId) {
            alert('Please select an artifact');
            return;
        }

        const btn = document.getElementById('btn-hybrid-classify');
        btn.textContent = '‚è≥ Classifying...';
        btn.disabled = true;

        try {
            const response = await fetch('/web/hybrid-classify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ artifact_id: artifactId })
            });

            const data = await response.json();

            if (response.ok) {
                displayHybridResults(data);
            } else {
                alert(`Error: ${data.error || 'Hybrid classification failed'}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            btn.textContent = '‚ö° Hybrid Classification';
            btn.disabled = false;
        }
    });

    // ML Training
    document.getElementById('btn-ml-train').addEventListener('click', async () => {
        const algorithm = document.getElementById('ml-algorithm').value;

        if (!confirm('Train ML model? This may take a few seconds.')) {
            return;
        }

        const btn = document.getElementById('btn-ml-train');
        btn.textContent = '‚è≥ Training...';
        btn.disabled = true;

        try {
            const response = await fetch('/web/ml-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ algorithm })
            });

            const data = await response.json();

            if (response.ok) {
                displayTrainingResults(data);
                await checkSystemStatus();  // Refresh status
            } else {
                alert(`Error: ${data.error || 'Training failed'}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            btn.textContent = 'üéì Train Model';
            btn.disabled = false;
        }
    });

    // Automatic Stylistic Classification
    document.getElementById('btn-auto-classify').addEventListener('click', async () => {
        if (!confirm('Automatically classify all unclassified artifacts? This may take several minutes depending on the number of artifacts.')) {
            return;
        }

        const btn = document.getElementById('btn-auto-classify');
        const resultsDiv = document.getElementById('auto-classify-results');
        const resultsContent = document.getElementById('auto-classify-results-content');

        btn.textContent = '‚è≥ Classifying...';
        btn.disabled = true;
        resultsDiv.style.display = 'block';
        resultsContent.innerHTML = '<p style="text-align: center;"><em>Processing artifacts...</em></p>';

        try {
            const response = await fetch('/web/auto-classify-stylistic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            const data = await response.json();

            if (response.ok) {
                // Display summary
                let html = `
                    <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #2e7d32;">‚úì Classification Complete</h4>
                        <p><strong>Total Artifacts:</strong> ${data.total}</p>
                        <p><strong>Unclassified:</strong> ${data.unclassified}</p>
                        <p><strong>Processed:</strong> ${data.processed}</p>
                        <p><strong>Auto-Classified (>80% confidence):</strong> ${data.auto_classified}</p>
                    </div>
                `;

                // Display individual results
                if (data.results && data.results.length > 0) {
                    html += '<h4>Individual Results:</h4><div style="max-height: 400px; overflow-y: auto;">';

                    data.results.forEach(result => {
                        const bgColor = result.confidence > 0.8 ? '#e8f5e9' :
                                       result.confidence > 0.5 ? '#fff3e0' : '#ffebee';
                        const borderColor = result.confidence > 0.8 ? '#4caf50' :
                                           result.confidence > 0.5 ? '#ff9800' : '#f44336';

                        html += `
                            <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 12px; margin-bottom: 10px;">
                                <h5 style="margin: 0 0 8px 0;">${result.artifact_id}</h5>
                                ${result.error ? `<p style="color: #d32f2f;"><strong>Error:</strong> ${result.error}</p>` : `
                                    <p><strong>Recommended Class:</strong> ${result.recommended_class || 'N/A'}</p>
                                    <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                                    <p><strong>Stylistic Score:</strong> ${result.stylistic_score ? result.stylistic_score.toFixed(2) : 'N/A'}</p>
                                    ${result.ml_prediction ? `<p><strong>ML:</strong> ${result.ml_prediction} (${(result.ml_confidence * 100).toFixed(1)}%)</p>` : ''}
                                    ${result.ai_suggestion ? `<details><summary>AI Suggestion</summary><p style="font-size: 12px; margin-top: 8px;">${result.ai_suggestion}</p></details>` : ''}
                                `}
                            </div>
                        `;
                    });

                    html += '</div>';
                }

                resultsContent.innerHTML = html;

                btn.textContent = '‚úì Classification Complete!';
                setTimeout(() => {
                    btn.textContent = 'üöÄ Run Automatic Classification';
                    btn.disabled = false;
                }, 3000);

            } else {
                alert(`Error: ${data.error || 'Classification failed'}`);
                btn.textContent = 'üöÄ Run Automatic Classification';
                btn.disabled = false;
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
            btn.textContent = 'üöÄ Run Automatic Classification';
            btn.disabled = false;
        }
    });
});

async function checkAPIKeyStatus() {
    try {
        const response = await fetch('/web/config/api-key');
        const data = await response.json();

        const statusBadge = document.getElementById('key-status-badge');
        const maskedKeyDisplay = document.getElementById('masked-key-display');
        const maskedKey = document.getElementById('masked-key');
        const deleteBtn = document.getElementById('btn-delete-api-key');

        if (data.configured) {
            statusBadge.innerHTML = '<span class="status-badge status-active">‚úì Configured</span>';
            maskedKey.textContent = data.masked_key;
            maskedKeyDisplay.style.display = 'block';
            deleteBtn.style.display = 'inline-block';
        } else {
            statusBadge.innerHTML = '<span class="status-badge status-inactive">Not configured</span>';
            maskedKeyDisplay.style.display = 'none';
            deleteBtn.style.display = 'none';
        }
    } catch (error) {
        console.error('Error checking API key status:', error);
        document.getElementById('key-status-badge').innerHTML =
            '<span class="status-badge status-warning">Error checking status</span>';
    }
}

function showAPIKeyMessage(message, type) {
    const msgDiv = document.getElementById('api-key-message');
    msgDiv.textContent = message;
    msgDiv.style.display = 'block';
    msgDiv.style.padding = '10px';
    msgDiv.style.borderRadius = '4px';
    msgDiv.style.marginTop = '10px';

    if (type === 'success') {
        msgDiv.style.backgroundColor = '#d4edda';
        msgDiv.style.color = '#155724';
        msgDiv.style.border = '1px solid #c3e6cb';
    } else {
        msgDiv.style.backgroundColor = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.border = '1px solid #f5c6cb';
    }

    setTimeout(() => {
        msgDiv.style.display = 'none';
    }, 5000);
}

function toggleHelp() {
    const content = document.getElementById('help-content');
    const btn = document.getElementById('help-toggle-btn');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = '‚ñ≤ Hide Help';
    } else {
        content.style.display = 'none';
        btn.textContent = '‚ñº Show Help';
    }
}

async function checkSystemStatus() {
    // Check AI status
    try {
        const response = await fetch('/web/statistics');
        const data = await response.json();

        document.getElementById('ai-status-badge').innerHTML =
            '<span class="status-badge status-warning">Optional (set ANTHROPIC_API_KEY)</span>';

        document.getElementById('db-status-badge').innerHTML =
            `<span class="status-badge status-active">‚úì Active (${data.meshes?.loaded || 0} artifacts)</span>`;

        // Check training data
        const trainingCount = data.training_data?.total || 0;
        document.getElementById('training-samples-count').textContent = trainingCount;

        if (trainingCount >= 10) {
            document.getElementById('ml-status-badge').innerHTML =
                '<span class="status-badge status-active">‚úì Ready to train</span>';
            document.getElementById('model-status').textContent =
                `${trainingCount} samples available`;
        } else {
            document.getElementById('ml-status-badge').innerHTML =
                '<span class="status-badge status-inactive">Need more training data</span>';
            document.getElementById('model-status').textContent =
                `Need ${10 - trainingCount} more samples (min 10)`;
        }
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

function displayAIResults(data) {
    const container = document.getElementById('ai-results-content');
    const analysis = data.ai_analysis?.analysis || JSON.stringify(data.ai_analysis, null, 2);

    container.innerHTML = `
        <div class="result-item">
            <div class="result-label">Artifact ID:</div>
            <div>${data.artifact_id}</div>
        </div>
        <div class="result-item">
            <div class="result-label">AI Analysis:</div>
            <pre style="white-space: pre-wrap; font-family: inherit; margin: 10px 0;">${analysis}</pre>
        </div>
    `;

    document.getElementById('ai-results').style.display = 'block';
}

function displayMLResults(data) {
    const container = document.getElementById('ml-results-content');
    const prediction = data.prediction;
    const explanation = data.explanation;

    let html = `
        <div class="result-item">
            <div class="result-label">Predicted Class:</div>
            <div style="font-size: 18px; font-weight: 600; color: #667eea;">
                ${prediction.prediction}
            </div>
        </div>
        <div class="result-item">
            <div class="result-label">Confidence:</div>
            <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${prediction.confidence * 100}%">
                    ${(prediction.confidence * 100).toFixed(1)}%
                </div>
            </div>
        </div>
    `;

    if (prediction.top_predictions) {
        html += `
            <div class="result-item">
                <div class="result-label">Top 3 Predictions:</div>
                <ul style="margin: 8px 0; padding-left: 20px;">
        `;
        prediction.top_predictions.forEach(pred => {
            html += `<li>${pred.class}: ${(pred.confidence * 100).toFixed(1)}%</li>`;
        });
        html += '</ul></div>';
    }

    if (explanation?.key_features) {
        html += `
            <div class="result-item">
                <div class="result-label">Key Features:</div>
                <ul style="margin: 8px 0; padding-left: 20px;">
        `;
        explanation.key_features.forEach(feat => {
            html += `<li><strong>${feat.feature}:</strong> ${feat.value.toFixed(2)} (importance: ${(feat.importance * 100).toFixed(1)}%)</li>`;
        });
        html += '</ul></div>';
    }

    container.innerHTML = html;
    document.getElementById('ml-results').style.display = 'block';
}

function displayHybridResults(data) {
    const container = document.getElementById('hybrid-results-content');

    let html = `
        <div class="result-item">
            <div class="result-label">Recommendation:</div>
            <div style="font-size: 16px; font-weight: 600; color: #667eea; margin-top: 8px;">
                ${data.recommendation}
            </div>
        </div>
        <div class="result-item">
            <div class="result-label">Rule-Based Result:</div>
            <div>${data.rule_based?.assigned_class || 'No class assigned'}</div>
        </div>
    `;

    if (data.ml_based && !data.ml_based.error) {
        html += `
            <div class="result-item">
                <div class="result-label">ML Prediction:</div>
                <div>${data.ml_based.prediction} (${(data.ml_based.confidence * 100).toFixed(1)}%)</div>
            </div>
        `;
    }

    container.innerHTML = html;
    document.getElementById('hybrid-results').style.display = 'block';
}

function displayTrainingResults(data) {
    const container = document.getElementById('training-results-content');

    if (data.error) {
        container.innerHTML = `<div style="color: #c53030;">Error: ${data.error}</div>`;
    } else {
        let html = `
            <div class="result-item">
                <div class="result-label">Training Accuracy:</div>
                <div>${(data.train_accuracy * 100).toFixed(1)}%</div>
            </div>
            <div class="result-item">
                <div class="result-label">Validation Accuracy:</div>
                <div>${(data.val_accuracy * 100).toFixed(1)}%</div>
            </div>
            <div class="result-item">
                <div class="result-label">Cross-Validation:</div>
                <div>${(data.cv_scores.mean * 100).toFixed(1)}% ¬± ${(data.cv_scores.std * 100).toFixed(1)}%</div>
            </div>
            <div class="result-item">
                <div class="result-label">Classes:</div>
                <div>${data.classes.join(', ')}</div>
            </div>
        `;

        if (data.feature_importance) {
            html += '<div class="result-item"><div class="result-label">Top Features:</div><ul style="margin: 8px 0; padding-left: 20px;">';
            const topFeatures = Object.entries(data.feature_importance).slice(0, 5);
            topFeatures.forEach(([feat, imp]) => {
                html += `<li>${feat}: ${(imp * 100).toFixed(1)}%</li>`;
            });
            html += '</ul></div>';
        }

        container.innerHTML = html;
    }

    document.getElementById('training-results').style.display = 'block';
}
</script>
{% endblock %}
