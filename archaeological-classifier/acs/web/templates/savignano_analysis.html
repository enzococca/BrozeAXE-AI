{% extends "base.html" %}

{% block title %}Savignano Analysis - Archaeological Classifier{% endblock %}

{% block content %}
<style>
.savignano-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px;
    border-radius: 12px;
    margin-bottom: 30px;
}
.step-card {
    background: white;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    border-left: 5px solid #667eea;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.step-card.completed {
    border-left-color: #48bb78;
    background: #f0fff4;
}
.step-card.active {
    border-left-color: #ed8936;
    background: #fffaf0;
}
.step-number {
    background: #667eea;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    margin-right: 15px;
}
.progress-bar-custom {
    width: 100%;
    height: 30px;
    background: #e2e8f0;
    border-radius: 15px;
    overflow: hidden;
    margin: 20px 0;
}
.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}
.result-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.metric {
    text-align: center;
    padding: 20px;
}
.metric-value {
    font-size: 42px;
    font-weight: bold;
    color: #667eea;
}
.metric-label {
    color: #718096;
    font-size: 14px;
    margin-top: 5px;
}
/* Results Viewer Modal Styles */
.results-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
}
.results-modal-content {
    background: white;
    max-width: 1200px;
    margin: 0 auto;
    border-radius: 12px;
    padding: 30px;
    position: relative;
}
.results-close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 28px;
    cursor: pointer;
    color: #718096;
}
.results-close:hover {
    color: #e53e3e;
}
.results-section {
    margin-bottom: 30px;
    padding: 20px;
    background: #f7fafc;
    border-radius: 8px;
}
.results-section h3 {
    color: #667eea;
    margin: 0 0 15px 0;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
}
.matrix-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #667eea;
}
.matrix-card h4 {
    margin: 0 0 10px 0;
    color: #2d3748;
}
.matrix-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}
.stat-item {
    text-align: center;
    padding: 10px;
    background: #f7fafc;
    border-radius: 6px;
}
.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #667eea;
}
.stat-label {
    font-size: 12px;
    color: #718096;
}
.qa-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.qa-question {
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 10px;
}
.qa-answer {
    color: #4a5568;
    line-height: 1.6;
}
.viz-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
}
.viz-item {
    text-align: center;
}
.viz-item img {
    max-width: 100%;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>

<div class="savignano-hero">
    <h1 style="margin: 0 0 10px 0;">üó°Ô∏è Savignano sul Panaro - Complete Archaeological Analysis</h1>
    <p style="margin: 0; font-size: 18px; opacity: 0.9;">
        Advanced AI-powered analysis system for the 96 bronze axes hoard
    </p>
    <p style="margin: 10px 0 0 0; opacity: 0.8; font-size: 14px;">
        Bronze Age (Middle/Recent, ca. 1600-1300 BCE) - Modena, Italy
    </p>
</div>

<!-- Analysis Status -->
<div id="analysis-status-section" style="margin-bottom: 30px;">
    <div class="card">
        <h2 style="margin: 0 0 20px 0;">üìä Analysis Status</h2>
        <div id="analysis-status-content">
            <p style="color: #718096;">No analysis running. Start a new analysis below.</p>
        </div>
    </div>
</div>

<!-- Workflow Steps -->
<div id="workflow-section">
    <!-- STEP 1: Select or Upload Meshes -->
    <div class="step-card" id="step-1">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <span class="step-number">1</span>
            <h3 style="margin: 0; flex: 1;">Select Artifacts or Upload New</h3>
            <span id="step-1-status" class="badge badge-secondary">Pending</span>
        </div>
        <p style="color: #718096; margin-bottom: 20px;">
            Select artifacts already loaded in the project or upload new 3D meshes.
        </p>

        <!-- Source Selection Tabs -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" id="tab-project" onclick="showSourceTab('project')" style="flex: 1; background: #667eea; color: white;">
                üì¶ From Project
            </button>
            <button class="btn btn-outline" id="tab-upload" onclick="showSourceTab('upload')" style="flex: 1;">
                üì§ Upload New
            </button>
        </div>

        <!-- Project Artifacts Selection -->
        <div id="source-project" style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <label class="form-label" style="font-weight: bold; margin: 0;">Select Artifacts from Project</label>
                <div>
                    <button class="btn btn-sm btn-secondary" onclick="selectAllArtifacts()">Select All</button>
                    <button class="btn btn-sm btn-outline" onclick="deselectAllArtifacts()">Deselect All</button>
                    <button class="btn btn-sm btn-outline" onclick="loadProjectArtifacts()">üîÑ Refresh</button>
                </div>
            </div>
            <div id="project-artifacts-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
                <p style="padding: 20px; color: #718096; text-align: center;">Loading artifacts...</p>
            </div>
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                <small class="form-text"><span id="selected-count">0</span> artifacts selected</small>
                <small class="form-text" style="color: #667eea;"><span id="total-artifacts-count">0</span> total artifacts in project</small>
            </div>
        </div>

        <!-- Upload New Meshes (Hidden by default) -->
        <div id="source-upload" style="display: none; background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <label class="form-label" style="font-weight: bold;">3D Mesh Files</label>
            <input type="file" id="mesh-files" multiple accept=".obj,.stl,.ply" class="form-control" style="margin-bottom: 15px;">
            <small class="form-text">Select multiple files (Ctrl/Cmd + Click). Supported: .obj, .stl, .ply</small>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <label class="form-label" style="font-weight: bold;">Weights Data (Optional)</label>

            <!-- Option 1: No weights -->
            <div style="margin-bottom: 10px;">
                <label style="font-weight: normal;">
                    <input type="radio" name="weights-option" value="none" checked>
                    No weights (peso = 0)
                </label>
            </div>

            <!-- Option 2: Manual input -->
            <div style="margin-bottom: 10px;">
                <label style="font-weight: normal;">
                    <input type="radio" name="weights-option" value="manual">
                    Manual input (type weight for each file)
                </label>
            </div>
            <div id="manual-weights-container" style="display: none; margin: 10px 0 15px 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                <p style="color: #718096; font-size: 14px; margin-bottom: 10px;">
                    Weights will appear here after selecting mesh files
                </p>
            </div>

            <!-- Option 3: Excel/CSV file -->
            <div style="margin-bottom: 10px;">
                <label style="font-weight: normal;">
                    <input type="radio" name="weights-option" value="excel">
                    Upload Excel/CSV file
                </label>
            </div>
            <input type="file" id="weights-excel" accept=".xlsx,.xls,.csv" class="form-control" disabled style="margin-bottom: 10px;">
            <small class="form-text" id="excel-help" style="display: none; margin-left: 20px;">
                Excel/CSV format: columns "artifact_id" and "weight" (or "peso")
            </small>

            <!-- Option 4: DOCX scan notes -->
            <div style="margin-bottom: 10px;">
                <label style="font-weight: normal;">
                    <input type="radio" name="weights-option" value="docx">
                    Upload DOCX scan notes (auto-extract)
                </label>
            </div>
            <input type="file" id="weights-docx" accept=".docx" class="form-control" disabled style="margin-bottom: 10px;">

            <!-- Option 5: JSON file -->
            <div style="margin-bottom: 10px;">
                <label style="font-weight: normal;">
                    <input type="radio" name="weights-option" value="json">
                    Upload JSON file
                </label>
            </div>
            <input type="file" id="weights-json" accept=".json" class="form-control" disabled>

            <small class="form-text" style="margin-top: 10px; display: block;">
                Optional: Provide weight data for more accurate archaeological analysis
            </small>
        </div>

        <button class="btn btn-primary btn-lg" onclick="startAnalysis()" id="start-btn">
            üöÄ Start Analysis
        </button>
        <span id="upload-progress" style="margin-left: 15px; color: #718096;"></span>
    </div>

    <!-- STEP 2: Configure Analysis -->
    <div class="step-card" id="step-2" style="display: none;">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <span class="step-number">2</span>
            <h3 style="margin: 0; flex: 1;">Configure Analysis Parameters</h3>
            <span id="step-2-status" class="badge badge-secondary">Pending</span>
        </div>
        <p style="color: #718096; margin-bottom: 20px;">
            Set analysis parameters for matrix identification and AI interpretation.
        </p>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Clustering Method</label>
                    <select id="clustering-method" class="form-control">
                        <option value="hierarchical" selected>Hierarchical Clustering (Recommended)</option>
                        <option value="kmeans">K-Means Clustering</option>
                    </select>
                    <small class="form-text">Algorithm for identifying mold groups</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Maximum Matrices</label>
                    <input type="number" id="max-clusters" class="form-control" value="15" min="2" max="30">
                    <small class="form-text">Max number of molds to identify (auto-optimized)</small>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                <input type="checkbox" id="use-ai" checked>
                Enable AI Archaeological Interpretation (Claude Sonnet 4.5)
            </label>
            <small class="form-text">
                AI provides comprehensive archaeological interpretation of results.
                Uses server-configured API key.
            </small>
        </div>

        <button class="btn btn-primary btn-lg" onclick="configureAnalysis()">
            ‚öôÔ∏è Configure & Continue
        </button>
    </div>

    <!-- STEP 3: Running Analysis -->
    <div class="step-card" id="step-3" style="display: none;">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <span class="step-number">3</span>
            <h3 style="margin: 0; flex: 1;">Running Analysis</h3>
            <span id="step-3-status" class="badge badge-warning">Running...</span>
        </div>

        <div id="analysis-progress">
            <div class="progress-bar-custom">
                <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%;">0%</div>
            </div>
            <div id="analysis-log" style="background: #f7fafc; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px;">
                <div style="color: #667eea;">üöÄ Initializing Savignano analysis workflow...</div>
            </div>
        </div>
    </div>

    <!-- STEP 4: Results -->
    <div class="step-card" id="step-4" style="display: none;">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <span class="step-number">4</span>
            <h3 style="margin: 0; flex: 1;">Analysis Results</h3>
            <span id="step-4-status" class="badge badge-success">Completed</span>
        </div>

        <!-- Key Metrics -->
        <div class="row" style="margin-bottom: 30px;">
            <div class="col-md-3">
                <div class="metric">
                    <div class="metric-value" id="result-n-axes">-</div>
                    <div class="metric-label">Axes Analyzed</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric">
                    <div class="metric-value" id="result-n-matrices">-</div>
                    <div class="metric-label">Matrices Identified</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric">
                    <div class="metric-value" id="result-total-fusions">-</div>
                    <div class="metric-label">Total Fusions</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric">
                    <div class="metric-value" id="result-silhouette">-</div>
                    <div class="metric-label">Quality Score</div>
                </div>
            </div>
        </div>

        <!-- Download Files -->
        <div class="result-card">
            <h4 style="margin: 0 0 15px 0;">üì• Download Results</h4>
            <div class="row">
                <div class="col-md-6">
                    <h5>Data Files</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-outline" onclick="downloadFile('features_csv')">
                                üìä Morphometric Features (CSV)
                            </button>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-outline" onclick="downloadFile('matrices_json')">
                                üî¨ Matrices Summary (JSON)
                            </button>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-outline" onclick="downloadFile('matrix_assignments_csv')">
                                üóÇÔ∏è Matrix Assignments (CSV)
                            </button>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-outline" onclick="downloadFile('fusions_json')">
                                ‚öíÔ∏è Fusions Analysis (JSON)
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>Reports & Visualizations</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="downloadFile('report_md')">
                                üìÑ Archaeological Report (Markdown)
                            </button>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-outline" onclick="downloadFile('answers_json')">
                                ‚ùì Q&A Answers (JSON)
                            </button>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-outline" onclick="downloadFile('dendrogram_png')">
                                üå≥ Dendrogram (PNG)
                            </button>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-outline" onclick="downloadFile('pca_png')">
                                üìà PCA Clusters (PNG)
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Archaeological Questions Summary -->
        <div class="result-card">
            <h4 style="margin: 0 0 15px 0;">üîç Archaeological Questions Answered</h4>
            <div id="qa-summary">
                <p style="color: #718096;">Loading Q&A summary...</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn btn-primary btn-lg" onclick="showFormattedResults()">
                üìä View Detailed Report
            </button>
            <button class="btn btn-lg" style="background: #e53e3e; color: white;" onclick="exportPDF()">
                üìÑ Export PDF
            </button>
            <button class="btn btn-secondary" onclick="startNewAnalysis()">
                üîÑ Start New Analysis
            </button>
        </div>
    </div>
</div>

<!-- Results Viewer Modal -->
<div id="results-modal" class="results-modal" onclick="closeResultsModal(event)">
    <div class="results-modal-content" onclick="event.stopPropagation()">
        <span class="results-close" onclick="closeResultsModal()">&times;</span>
        <h2 style="margin: 0 0 25px 0; color: #2d3748;">üìä Savignano Analysis - Detailed Report</h2>

        <!-- Summary Section -->
        <div class="results-section">
            <h3>üéØ Analysis Summary</h3>
            <div id="modal-summary" class="matrix-stats">
                <div class="stat-item">
                    <div class="stat-value" id="modal-axes">-</div>
                    <div class="stat-label">Axes Analyzed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="modal-matrices">-</div>
                    <div class="stat-label">Matrices Identified</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="modal-fusions">-</div>
                    <div class="stat-label">Total Fusions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="modal-silhouette">-</div>
                    <div class="stat-label">Quality Score</div>
                </div>
            </div>
        </div>

        <!-- Matrices Details -->
        <div class="results-section">
            <h3>üî¨ Matrices Details</h3>
            <div id="modal-matrices-details">
                <p style="color: #718096;">Loading matrices data...</p>
            </div>
        </div>

        <!-- Visualizations -->
        <div class="results-section">
            <h3>üìà Visualizations</h3>
            <div class="viz-container" id="modal-visualizations">
                <div class="viz-item">
                    <h4>Dendrogram</h4>
                    <img id="viz-dendrogram" src="" alt="Dendrogram" style="display: none;">
                    <p id="viz-dendrogram-placeholder" style="color: #718096; padding: 40px;">Loading visualization...</p>
                </div>
                <div class="viz-item">
                    <h4>PCA Clusters</h4>
                    <img id="viz-pca" src="" alt="PCA Clusters" style="display: none;">
                    <p id="viz-pca-placeholder" style="color: #718096; padding: 40px;">Loading visualization...</p>
                </div>
            </div>
        </div>

        <!-- Archaeological Q&A -->
        <div class="results-section">
            <h3>‚ùì Archaeological Questions & Answers</h3>
            <div id="modal-qa-details">
                <p style="color: #718096;">Loading Q&A data...</p>
            </div>
        </div>

        <!-- Download Section -->
        <div class="results-section">
            <h3>üì• Export Options</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="exportPDF()">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="downloadFile('report_md')">üìù Markdown Report</button>
                <button class="btn btn-outline" onclick="downloadFile('features_csv')">üìä Features CSV</button>
                <button class="btn btn-outline" onclick="downloadFile('matrices_json')">üî¨ Matrices JSON</button>
            </div>
        </div>
    </div>
</div>

<!-- Info Panel -->
<div class="card" style="margin-top: 30px; background: #fffaf0; border-left: 4px solid #ed8936;">
    <h3 style="margin: 0 0 15px 0; color: #ed8936;">‚ÑπÔ∏è About This Analysis</h3>
    <p style="margin: 0 0 10px 0; color: #718096;">
        This system performs a complete archaeological analysis of the Savignano sul Panaro bronze axes hoard, answering 6 key archaeological questions:
    </p>
    <ol style="color: #718096; margin: 0;">
        <li>Number of molds used and their technical characteristics (mono/bivalve, socket, raised edges)</li>
        <li>Number of casts per mold</li>
        <li>Post-casting treatments (hammering, central bar, butt)</li>
        <li>Final finishing techniques (blade and butt)</li>
        <li>Function of the butt socket (hafting hypothesis)</li>
        <li>Use-wear intensity and preservation</li>
    </ol>
    <p style="margin: 15px 0 0 0; color: #718096;">
        <strong>Methodology:</strong> Morphometric 3D analysis + Machine Learning clustering + AI interpretation (Claude Sonnet 4.5)
    </p>
</div>

<script>
let currentAnalysisId = null;
let uploadedFiles = [];
let manualWeights = {};
let selectedArtifacts = new Set();
let projectArtifacts = [];
let sourceMode = 'project'; // 'project' or 'upload'

// Load artifacts from project on page load
document.addEventListener('DOMContentLoaded', loadProjectArtifacts);

function showSourceTab(tab) {
    sourceMode = tab;
    // Update tab buttons
    document.getElementById('tab-project').className = tab === 'project' ? 'btn' : 'btn btn-outline';
    document.getElementById('tab-project').style.background = tab === 'project' ? '#667eea' : '';
    document.getElementById('tab-project').style.color = tab === 'project' ? 'white' : '';
    document.getElementById('tab-upload').className = tab === 'upload' ? 'btn' : 'btn btn-outline';
    document.getElementById('tab-upload').style.background = tab === 'upload' ? '#667eea' : '';
    document.getElementById('tab-upload').style.color = tab === 'upload' ? 'white' : '';
    // Show/hide sections
    document.getElementById('source-project').style.display = tab === 'project' ? 'block' : 'none';
    document.getElementById('source-upload').style.display = tab === 'upload' ? 'block' : 'none';
}

async function loadProjectArtifacts() {
    const listEl = document.getElementById('project-artifacts-list');
    listEl.innerHTML = '<p style="padding: 20px; color: #718096; text-align: center;">Loading artifacts...</p>';

    try {
        const response = await AuthHelper.fetch('/web/savignano-artifacts-list');
        const data = await response.json();

        if (data.status === 'success') {
            projectArtifacts = data.artifacts;
            document.getElementById('total-artifacts-count').textContent = data.total;

            if (projectArtifacts.length === 0) {
                listEl.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #718096;">
                        <p style="font-size: 16px; margin-bottom: 10px;">üì≠ No artifacts found in project</p>
                        <p style="font-size: 14px;">Use the "Upload New" tab to upload 3D meshes</p>
                    </div>
                `;
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += `<thead style="background: #f7fafc; position: sticky; top: 0;">
                <tr>
                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">
                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)">
                    </th>
                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">ID</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #e2e8f0;">Savignano</th>
                    <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">Length</th>
                    <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">Width</th>
                    <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">Weight</th>
                </tr>
            </thead><tbody>`;

            for (const artifact of projectArtifacts) {
                const hasFeatures = artifact.has_savignano_features;
                html += `
                    <tr style="border-bottom: 1px solid #e2e8f0; ${hasFeatures ? '' : 'opacity: 0.6;'}">
                        <td style="padding: 10px;">
                            <input type="checkbox" class="artifact-checkbox" data-id="${artifact.id}"
                                   onchange="toggleArtifact('${artifact.id}', this.checked)"
                                   ${selectedArtifacts.has(artifact.id) ? 'checked' : ''}>
                        </td>
                        <td style="padding: 10px; font-weight: 500;">${artifact.id}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${hasFeatures ?
                                '<span style="color: #48bb78;">‚úì ' + artifact.feature_count + ' features</span>' :
                                '<span style="color: #a0aec0;">‚Äì</span>'}
                        </td>
                        <td style="padding: 10px; text-align: right;">${artifact.length ? artifact.length.toFixed(1) + ' mm' : '‚Äì'}</td>
                        <td style="padding: 10px; text-align: right;">${artifact.width ? artifact.width.toFixed(1) + ' mm' : '‚Äì'}</td>
                        <td style="padding: 10px; text-align: right;">${artifact.weight ? artifact.weight.toFixed(1) + ' g' : '‚Äì'}</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            listEl.innerHTML = html;
            updateSelectedCount();
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    } catch (error) {
        listEl.innerHTML = `<p style="padding: 20px; color: #e53e3e; text-align: center;">Error: ${error.message}</p>`;
    }
}

function toggleArtifact(id, checked) {
    if (checked) {
        selectedArtifacts.add(id);
    } else {
        selectedArtifacts.delete(id);
    }
    updateSelectedCount();
    onArtifactSelectionChange();
}

function toggleSelectAll(checked) {
    document.querySelectorAll('.artifact-checkbox').forEach(cb => {
        cb.checked = checked;
        toggleArtifact(cb.dataset.id, checked);
    });
}

function selectAllArtifacts() {
    document.getElementById('select-all-checkbox').checked = true;
    toggleSelectAll(true);
}

function deselectAllArtifacts() {
    document.getElementById('select-all-checkbox').checked = false;
    toggleSelectAll(false);
}

function updateSelectedCount() {
    document.getElementById('selected-count').textContent = selectedArtifacts.size;
}

// Toggle weights input based on radio selection
document.querySelectorAll('input[name="weights-option"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const value = this.value;

        // Disable all inputs
        document.getElementById('weights-excel').disabled = (value !== 'excel');
        document.getElementById('weights-docx').disabled = (value !== 'docx');
        document.getElementById('weights-json').disabled = (value !== 'json');

        // Show/hide manual weights container
        document.getElementById('manual-weights-container').style.display = (value === 'manual') ? 'block' : 'none';

        // Show/hide Excel help text
        document.getElementById('excel-help').style.display = (value === 'excel') ? 'block' : 'none';

        // Generate manual fields if manual selected
        if (value === 'manual') {
            generateManualWeightFields();
        }
    });
});

// Generate manual weight input fields when files are selected (upload mode)
document.getElementById('mesh-files').addEventListener('change', function() {
    const weightsOption = document.querySelector('input[name="weights-option"]:checked').value;
    if (weightsOption === 'manual') {
        generateManualWeightFields();
    }
});

function generateManualWeightFields() {
    const container = document.getElementById('manual-weights-container');

    // Check which mode we're in
    if (sourceMode === 'project') {
        // Project mode: use selected artifacts
        if (selectedArtifacts.size === 0) {
            container.innerHTML = '<p style="color: #718096; font-size: 14px; margin: 0;">Seleziona prima gli artefatti dal progetto</p>';
            return;
        }

        let html = '<p style="color: #4a5568; font-weight: 600; margin-bottom: 12px;">Inserisci peso (grammi) per ogni ascia:</p>';
        html += '<div style="max-height: 300px; overflow-y: auto;">';

        let i = 0;
        for (const artifactId of selectedArtifacts) {
            // Find artifact info for display
            const artifact = projectArtifacts.find(a => a.id === artifactId);
            const currentWeight = artifact?.weight || manualWeights[artifactId] || '';

            html += `
                <div style="margin-bottom: 12px; padding: 10px; background: #f7fafc; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                    <span style="flex: 1; color: #4a5568; font-size: 14px;">üè∫ ${artifactId}</span>
                    <input type="number"
                           id="weight-${i}"
                           data-artifact="${artifactId}"
                           class="form-control manual-weight-input"
                           placeholder="Peso (g)"
                           step="0.1"
                           min="0"
                           style="width: 150px;"
                           value="${currentWeight}">
                </div>
            `;
            i++;
        }

        html += '</div>';
        html += '<small class="form-text" style="display: block; margin-top: 10px;">Lascia vuoto per peso sconosciuto (peso = 0)</small>';

        container.innerHTML = html;

        // Add event listeners
        document.querySelectorAll('.manual-weight-input').forEach(input => {
            input.addEventListener('change', function() {
                const artifactId = this.dataset.artifact;
                const weight = parseFloat(this.value) || 0;
                manualWeights[artifactId] = weight;
            });
        });

    } else {
        // Upload mode: use selected files
        const meshFilesInput = document.getElementById('mesh-files');
        const files = meshFilesInput.files;

        if (files.length === 0) {
            container.innerHTML = '<p style="color: #718096; font-size: 14px; margin: 0;">Seleziona prima i file mesh</p>';
            return;
        }

        let html = '<p style="color: #4a5568; font-weight: 600; margin-bottom: 12px;">Inserisci peso (grammi) per ogni ascia:</p>';
        html += '<div style="max-height: 300px; overflow-y: auto;">';

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const filename = file.name;
            const artifactId = filename.replace(/\.(obj|stl|ply)$/i, '');

            html += `
                <div style="margin-bottom: 12px; padding: 10px; background: #f7fafc; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                    <span style="flex: 1; color: #4a5568; font-size: 14px;">üìÑ ${filename}</span>
                    <input type="number"
                           id="weight-${i}"
                           data-artifact="${artifactId}"
                           class="form-control manual-weight-input"
                           placeholder="Peso (g)"
                           step="0.1"
                           min="0"
                           style="width: 150px;"
                           value="${manualWeights[artifactId] || ''}">
                </div>
            `;
        }

        html += '</div>';
        html += '<small class="form-text" style="display: block; margin-top: 10px;">Lascia vuoto per peso sconosciuto (peso = 0)</small>';

        container.innerHTML = html;

        // Add event listeners
        document.querySelectorAll('.manual-weight-input').forEach(input => {
            input.addEventListener('change', function() {
                const artifactId = this.dataset.artifact;
                const weight = parseFloat(this.value) || 0;
                manualWeights[artifactId] = weight;
            });
        });
    }
}

// Regenerate weight fields when artifacts are selected/deselected
function onArtifactSelectionChange() {
    const weightsOption = document.querySelector('input[name="weights-option"]:checked').value;
    if (weightsOption === 'manual') {
        generateManualWeightFields();
    }
}

// Start analysis - handles both project and upload modes
async function startAnalysis() {
    const startBtn = document.getElementById('start-btn');
    const progressSpan = document.getElementById('upload-progress');

    // Check source mode
    if (sourceMode === 'project') {
        // Use selected artifacts from project
        if (selectedArtifacts.size === 0) {
            alert('Seleziona almeno un artefatto dal progetto');
            return;
        }

        startBtn.disabled = true;
        progressSpan.textContent = `Preparazione ${selectedArtifacts.size} artefatti...`;

        try {
            // Collect manual weights if provided
            const weightsOption = document.querySelector('input[name="weights-option"]:checked').value;
            let weightsData = {};
            if (weightsOption === 'manual') {
                document.querySelectorAll('.manual-weight-input').forEach(input => {
                    const artifactId = input.dataset.artifact;
                    const weight = parseFloat(input.value) || 0;
                    if (weight > 0) {
                        weightsData[artifactId] = weight;
                    }
                });
            }

            // Create analysis session from project artifacts
            const response = await AuthHelper.fetch('/api/savignano/start-from-project', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    artifact_ids: Array.from(selectedArtifacts),
                    weights: weightsData
                })
            });

            const result = await response.json();

            if (response.ok && result.analysis_id) {
                currentAnalysisId = result.analysis_id;
                uploadedFiles = Array.from(selectedArtifacts);

                progressSpan.textContent = `‚úì ${selectedArtifacts.size} artefatti pronti`;

                // Move to step 2
                document.getElementById('step-1').classList.add('completed');
                document.getElementById('step-1-status').textContent = 'Completed';
                document.getElementById('step-1-status').className = 'badge badge-success';
                document.getElementById('step-2').style.display = 'block';
                document.getElementById('step-2').classList.add('active');
                document.getElementById('step-2-status').textContent = 'Active';
                document.getElementById('step-2-status').className = 'badge badge-warning';
            } else {
                throw new Error(result.error || 'Failed to create analysis session');
            }
        } catch (error) {
            alert('Errore: ' + error.message);
            progressSpan.textContent = '';
        } finally {
            startBtn.disabled = false;
        }
        return;
    }

    // Upload mode - original logic
    const meshFilesInput = document.getElementById('mesh-files');
    const files = meshFilesInput.files;

    if (files.length === 0) {
        alert('Seleziona almeno un file mesh');
        return;
    }

    startBtn.disabled = true;
    progressSpan.textContent = `Caricamento ${files.length} file...`;

    // Prepare FormData
    const formData = new FormData();
    for (let file of files) {
        formData.append('files', file);
    }

    // Add weights based on selected option
    const weightsOption = document.querySelector('input[name="weights-option"]:checked').value;

    if (weightsOption === 'manual') {
        // Collect manual weights as JSON
        const weightsJson = {};
        for (let i = 0; i < files.length; i++) {
            const filename = files[i].name;
            const artifactId = filename.replace(/\.(obj|stl|ply)$/i, '');
            weightsJson[artifactId] = manualWeights[artifactId] || 0;
        }
        formData.append('weights_json', JSON.stringify(weightsJson));

    } else if (weightsOption === 'excel') {
        const excelFile = document.getElementById('weights-excel').files[0];
        if (excelFile) {
            formData.append('weights_file', excelFile);
        } else {
            alert('Please select an Excel/CSV file');
            startBtn.disabled = false;
            progressSpan.textContent = '';
            return;
        }

    } else if (weightsOption === 'docx') {
        const docxFile = document.getElementById('weights-docx').files[0];
        if (docxFile) {
            formData.append('weights_docx', docxFile);
        } else {
            alert('Please select a DOCX file');
            startBtn.disabled = false;
            progressSpan.textContent = '';
            return;
        }

    } else if (weightsOption === 'json') {
        const jsonFile = document.getElementById('weights-json').files[0];
        if (jsonFile) {
            formData.append('weights_file', jsonFile);
        } else {
            alert('Please select a JSON file');
            startBtn.disabled = false;
            progressSpan.textContent = '';
            return;
        }
    }
    // weightsOption === 'none' ‚Üí no weights sent (peso = 0 for all)

    try {
        const response = await AuthHelper.fetch('/api/savignano/upload-batch', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            currentAnalysisId = result.analysis_id;
            uploadedFiles = result.files;
            progressSpan.textContent = `‚úì Uploaded ${result.n_files_uploaded} files successfully`;
            document.getElementById('step-1-status').textContent = 'Completed';
            document.getElementById('step-1-status').className = 'badge badge-success';
            document.getElementById('step-1').classList.add('completed');

            // Show step 2
            document.getElementById('step-2').style.display = 'block';
            document.getElementById('step-2').classList.add('active');
            document.getElementById('step-2-status').textContent = 'Active';
            document.getElementById('step-2-status').className = 'badge badge-warning';
        } else {
            alert('Upload failed: ' + result.error);
            startBtn.disabled = false;
            progressSpan.textContent = '';
        }
    } catch (error) {
        alert('Upload error: ' + error.message);
        startBtn.disabled = false;
        progressSpan.textContent = '';
    }
}

async function configureAnalysis() {
    if (!currentAnalysisId) {
        alert('Sessione di analisi non trovata. Seleziona prima gli artefatti e avvia l\'analisi.');
        return;
    }

    const config = {
        clustering_method: document.getElementById('clustering-method').value,
        max_clusters: parseInt(document.getElementById('max-clusters').value),
        use_ai: document.getElementById('use-ai').checked
        // API key is configured server-side
    };

    try {
        const response = await AuthHelper.fetch('/api/savignano/configure', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                analysis_id: currentAnalysisId,
                config: config
            })
        });

        const result = await response.json();

        if (response.ok) {
            document.getElementById('step-2-status').textContent = 'Completed';
            document.getElementById('step-2-status').className = 'badge badge-success';
            document.getElementById('step-2').classList.remove('active');
            document.getElementById('step-2').classList.add('completed');

            // Show step 3 and run analysis
            document.getElementById('step-3').style.display = 'block';
            document.getElementById('step-3').classList.add('active');
            runAnalysis();
        } else {
            alert('Configuration failed: ' + result.error);
        }
    } catch (error) {
        alert('Configuration error: ' + error.message);
    }
}

async function runAnalysis() {
    if (!currentAnalysisId) return;

    const logDiv = document.getElementById('analysis-log');
    const progressBar = document.getElementById('progress-bar-fill');

    function addLog(message, type = 'info') {
        const colors = {
            'info': '#667eea',
            'success': '#48bb78',
            'warning': '#ed8936',
            'error': '#f56565'
        };
        const entry = document.createElement('div');
        entry.style.color = colors[type];
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    addLog('Starting comprehensive analysis...', 'info');
    progressBar.style.width = '10%';
    progressBar.textContent = '10%';

    try {
        // Start analysis
        addLog('Step 1/4: Extracting morphometric features from 3D meshes...', 'info');
        progressBar.style.width = '30%';
        progressBar.textContent = '30%';

        const response = await AuthHelper.fetch('/api/savignano/run-analysis', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({analysis_id: currentAnalysisId})
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Analysis failed');
        }

        addLog('Step 2/4: Identifying mold matrices via hierarchical clustering...', 'info');
        progressBar.style.width = '60%';
        progressBar.textContent = '60%';

        // Poll for completion (simple version - in production use websockets)
        await new Promise(resolve => setTimeout(resolve, 2000));

        addLog('Step 3/4: Estimating fusions per matrix...', 'info');
        progressBar.style.width = '80%';
        progressBar.textContent = '80%';

        await new Promise(resolve => setTimeout(resolve, 1500));

        addLog('Step 4/4: Generating archaeological Q&A with AI...', 'info');
        progressBar.style.width = '95%';
        progressBar.textContent = '95%';

        // Get results
        const result = await response.json();

        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        addLog('‚úì Analysis completed successfully!', 'success');

        // Show results
        document.getElementById('step-3-status').textContent = 'Completed';
        document.getElementById('step-3-status').className = 'badge badge-success';
        document.getElementById('step-3').classList.remove('active');
        document.getElementById('step-3').classList.add('completed');

        displayResults(result);

    } catch (error) {
        addLog('‚úó Error: ' + error.message, 'error');
        alert('Analysis failed: ' + error.message);
    }
}

async function displayResults(result) {
    document.getElementById('step-4').style.display = 'block';
    document.getElementById('step-4').classList.add('active');

    // Populate metrics
    const summary = result.results_summary || result.summary || {};
    document.getElementById('result-n-axes').textContent = summary.n_axes_analyzed || uploadedFiles.length;
    document.getElementById('result-n-matrices').textContent = summary.n_matrices || result.results_summary?.n_matrices || '-';
    document.getElementById('result-total-fusions').textContent = summary.total_fusions || result.results_summary?.total_fusions || '-';
    document.getElementById('result-silhouette').textContent = summary.silhouette_score?.toFixed(2) || '-';

    // Load full results for Q&A
    try {
        const fullResults = await AuthHelper.fetch(`/api/savignano/results/${currentAnalysisId}`);
        const fullData = await fullResults.json();

        // Display Q&A summary (simplified)
        const qaDiv = document.getElementById('qa-summary');
        qaDiv.innerHTML = `
            <p style="color: #48bb78; font-weight: bold;">‚úì All 6 archaeological questions answered</p>
            <p style="color: #718096;">Download the Archaeological Report (Markdown) for complete analysis.</p>
        `;
    } catch (e) {
        console.error('Could not load full results:', e);
    }
}

async function downloadFile(fileType) {
    if (!currentAnalysisId) {
        alert('No analysis results available');
        return;
    }

    try {
        const response = await AuthHelper.fetch(`/api/savignano/download/${currentAnalysisId}/${fileType}`);

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Download failed');
        }

        // Get filename from Content-Disposition header or generate one
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `${currentAnalysisId}_${fileType}`;
        if (contentDisposition) {
            const match = contentDisposition.match(/filename="?(.+)"?/);
            if (match) {
                filename = match[1];
            }
        }

        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

    } catch (error) {
        console.error('Download error:', error);
        alert('Download failed: ' + error.message);
    }
}

function startNewAnalysis() {
    if (confirm('Start a new analysis? This will clear the current session.')) {
        location.reload();
    }
}

// Cached results data
let cachedResults = null;

async function showFormattedResults() {
    if (!currentAnalysisId) {
        alert('No analysis results available');
        return;
    }

    const modal = document.getElementById('results-modal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';

    try {
        // Fetch full results if not cached
        if (!cachedResults) {
            const response = await AuthHelper.fetch(`/api/savignano/results/${currentAnalysisId}`);
            cachedResults = await response.json();
        }

        const results = cachedResults.results || cachedResults;
        const summary = results.results_summary || results.summary || {};

        // Populate summary
        document.getElementById('modal-axes').textContent = summary.n_axes_analyzed || uploadedFiles.length;
        document.getElementById('modal-matrices').textContent = summary.n_matrices || '-';
        document.getElementById('modal-fusions').textContent = summary.total_fusions || '-';
        document.getElementById('modal-silhouette').textContent = typeof summary.silhouette_score === 'number'
            ? summary.silhouette_score.toFixed(3) : '-';

        // Populate matrices details
        const matricesContainer = document.getElementById('modal-matrices-details');
        const matrices = results.matrices_summary || results.matrices || [];

        if (Array.isArray(matrices) && matrices.length > 0) {
            let html = '';
            matrices.forEach((matrix, index) => {
                const matrixId = matrix.matrix_id !== undefined ? matrix.matrix_id : index;
                html += `
                    <div class="matrix-card">
                        <h4>üî∂ Matrix ${matrixId}</h4>
                        <div class="matrix-stats">
                            <div class="stat-item">
                                <div class="stat-value">${matrix.n_axes || matrix.axes_count || '-'}</div>
                                <div class="stat-label">Axes</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${matrix.estimated_fusions || matrix.fusions || '-'}</div>
                                <div class="stat-label">Est. Fusions</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${matrix.mean_length?.toFixed(1) || '-'}</div>
                                <div class="stat-label">Mean Length (mm)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${matrix.mean_width?.toFixed(1) || '-'}</div>
                                <div class="stat-label">Mean Width (mm)</div>
                            </div>
                        </div>
                        ${matrix.axes_ids ? `<p style="margin-top: 10px; color: #718096; font-size: 12px;">Axes: ${Array.isArray(matrix.axes_ids) ? matrix.axes_ids.join(', ') : matrix.axes_ids}</p>` : ''}
                    </div>
                `;
            });
            matricesContainer.innerHTML = html;
        } else if (typeof matrices === 'object' && !Array.isArray(matrices)) {
            // Handle object format
            let html = '';
            Object.keys(matrices).forEach(key => {
                const matrix = matrices[key];
                html += `
                    <div class="matrix-card">
                        <h4>üî∂ Matrix ${key}</h4>
                        <div class="matrix-stats">
                            <div class="stat-item">
                                <div class="stat-value">${matrix.n_axes || matrix.axes_count || '-'}</div>
                                <div class="stat-label">Axes</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${matrix.estimated_fusions || matrix.fusions || '-'}</div>
                                <div class="stat-label">Est. Fusions</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            matricesContainer.innerHTML = html || '<p style="color: #718096;">No detailed matrix data available</p>';
        } else {
            matricesContainer.innerHTML = '<p style="color: #718096;">No detailed matrix data available</p>';
        }

        // Load visualizations
        loadVisualization('dendrogram_png', 'viz-dendrogram', 'viz-dendrogram-placeholder');
        loadVisualization('pca_png', 'viz-pca', 'viz-pca-placeholder');

        // Populate Q&A
        const qaContainer = document.getElementById('modal-qa-details');
        const qa = results.archaeological_qa || results.qa_answers || [];

        if (Array.isArray(qa) && qa.length > 0) {
            let html = '';
            qa.forEach((item, index) => {
                html += `
                    <div class="qa-item">
                        <div class="qa-question">Q${index + 1}: ${item.question || item.q || 'Question'}</div>
                        <div class="qa-answer">${formatAnswer(item.answer || item.a || 'No answer available')}</div>
                    </div>
                `;
            });
            qaContainer.innerHTML = html;
        } else {
            qaContainer.innerHTML = '<p style="color: #718096;">Q&A data not available. Download the Markdown report for full analysis.</p>';
        }

    } catch (error) {
        console.error('Error loading results:', error);
        document.getElementById('modal-matrices-details').innerHTML =
            '<p style="color: #e53e3e;">Error loading results: ' + error.message + '</p>';
    }
}

function formatAnswer(answer) {
    if (!answer) return '';
    // Convert markdown-like formatting to HTML
    return answer
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

async function loadVisualization(fileType, imgId, placeholderId) {
    const img = document.getElementById(imgId);
    const placeholder = document.getElementById(placeholderId);

    try {
        const response = await AuthHelper.fetch(`/api/savignano/download/${currentAnalysisId}/${fileType}`);

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            img.src = url;
            img.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            placeholder.textContent = 'Visualization not available';
        }
    } catch (error) {
        placeholder.textContent = 'Failed to load visualization';
    }
}

function closeResultsModal(event) {
    if (event && event.target !== document.getElementById('results-modal')) {
        return;
    }
    document.getElementById('results-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

async function exportPDF() {
    if (!currentAnalysisId) {
        alert('No analysis results available');
        return;
    }

    const btn = event?.target;
    const originalText = btn?.textContent;
    if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Generating PDF...';
    }

    try {
        const response = await AuthHelper.fetch(`/api/savignano/export-pdf/${currentAnalysisId}`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'PDF generation failed');
        }

        // Get filename from header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `savignano_analysis_${currentAnalysisId}.pdf`;
        if (contentDisposition) {
            const match = contentDisposition.match(/filename="?(.+)"?/);
            if (match) filename = match[1];
        }

        // Download PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

    } catch (error) {
        console.error('PDF export error:', error);
        alert('PDF export failed: ' + error.message);
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }
}

// Keyboard shortcut to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeResultsModal();
    }
});
</script>

{% endblock %}