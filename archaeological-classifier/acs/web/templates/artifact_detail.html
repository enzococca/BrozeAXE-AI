{% extends "base.html" %}

{% block title %}{{ artifact_id }} - Archaeological Classifier{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Artifact Details</h1>
        <p class="subtitle">{{ artifact_id }}</p>
    </div>

    <div class="detail-container">
        <div class="card">
            <h2>Geometric Features</h2>
            <div class="features-table">
                <div class="feature-row">
                    <span class="feature-label">Volume:</span>
                    <span class="feature-value">{{ "%.3f"|format(features.volume or 0) }} mm¬≥</span>
                </div>
                <div class="feature-row">
                    <span class="feature-label">Surface Area:</span>
                    <span class="feature-value">{{ "%.3f"|format(features.surface_area or 0) }} mm¬≤</span>
                </div>
                <div class="feature-row">
                    <span class="feature-label">Length:</span>
                    <span class="feature-value">{{ "%.3f"|format(features.length or 0) }} mm</span>
                </div>
                <div class="feature-row">
                    <span class="feature-label">Width:</span>
                    <span class="feature-value">{{ "%.3f"|format(features.width or 0) }} mm</span>
                </div>
                <div class="feature-row">
                    <span class="feature-label">Thickness:</span>
                    <span class="feature-value">{{ "%.3f"|format(features.thickness or 0) }} mm</span>
                </div>
                <div class="feature-row">
                    <span class="feature-label">Convexity:</span>
                    <span class="feature-value">{{ "%.3f"|format(features.convexity or 0) }}</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Mesh Properties</h2>
            <div class="features-table">
                <div class="feature-row">
                    <span class="feature-label">Vertices:</span>
                    <span class="feature-value">{{ features.n_vertices or 0 }}</span>
                </div>
                <div class="feature-row">
                    <span class="feature-label">Faces:</span>
                    <span class="feature-value">{{ features.n_faces or 0 }}</span>
                </div>
            </div>
        </div>

        {% if features.savignano %}
        <!-- Savignano Morphometric Features Section -->
        <div class="card full-width" style="background: linear-gradient(to bottom, #ffffff, #f0f4ff); border-left: 4px solid #667eea;">
            <h2>üó°Ô∏è Savignano Morphometric Analysis</h2>
            <p style="color: #718096; margin-bottom: 20px;">Specialized Bronze Age axe features (tallone, incavo, margini rialzati, tagliente)</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Tallone Card -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">üî∂ Tallone (Butt)</h3>
                    <div style="font-size: 18px; margin-bottom: 10px;">
                        L: {{ features.savignano.tallone_larghezza|round(1) if features.savignano.tallone_larghezza else 0 }} mm<br>
                        S: {{ features.savignano.tallone_spessore|round(1) if features.savignano.tallone_spessore else 0 }} mm
                    </div>
                </div>

                <!-- Incavo Card -->
                <div style="background: linear-gradient(135deg, #f687b3 0%, #c084fc 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">‚ö´ Incavo (Socket)</h3>
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">
                        {{ 'PRESENTE' if features.savignano.incavo_presente else 'ASSENTE' }}
                    </div>
                    {% if features.savignano.incavo_presente %}
                    <div style="font-size: 14px; opacity: 0.9;">
                        L: {{ features.savignano.incavo_larghezza|round(1) }} mm<br>
                        P: {{ features.savignano.incavo_profondita|round(1) }} mm<br>
                        Profilo: {{ features.savignano.incavo_profilo|upper if features.savignano.incavo_profilo else 'N/A' }}
                    </div>
                    {% endif %}
                </div>

                <!-- Margini Rialzati Card -->
                <div style="background: linear-gradient(135deg, #ed8936 0%, #f59e0b 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">üìè Margini Rialzati</h3>
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">
                        {{ 'PRESENTI' if features.savignano.margini_rialzati_presenti else 'ASSENTI' }}
                    </div>
                    {% if features.savignano.margini_rialzati_presenti %}
                    <div style="font-size: 14px; opacity: 0.9;">
                        L: {{ features.savignano.margini_rialzati_lunghezza|round(1) }} mm<br>
                        Smax: {{ features.savignano.margini_rialzati_spessore_max|round(2) }} mm
                    </div>
                    {% endif %}
                </div>

                <!-- Tagliente Card -->
                <div style="background: linear-gradient(135deg, #48bb78 0%, #10b981 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">‚öîÔ∏è Tagliente (Blade)</h3>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                        {{ features.savignano.tagliente_forma|upper|replace('_', ' ') if features.savignano.tagliente_forma else 'INDETERMINATO' }}
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        L: {{ features.savignano.tagliente_larghezza|round(1) if features.savignano.tagliente_larghezza else 0 }} mm<br>
                        Espanso: {{ 'S√å' if features.savignano.tagliente_espanso else 'NO' }}
                    </div>
                </div>

                <!-- Peso Card -->
                {% if features.savignano.peso and features.savignano.peso > 0 %}
                <div style="background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">‚öñÔ∏è Peso</h3>
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">
                        {{ features.savignano.peso|round(1) }} g
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Detailed Measurements -->
            <details style="margin-top: 20px;">
                <summary style="cursor: pointer; font-weight: 600; color: #667eea; padding: 10px; background: #f7fafc; border-radius: 8px;">
                    üìä View Complete Savignano Measurements
                </summary>
                <div style="padding: 20px; background: #f7fafc; border-radius: 8px; margin-top: 10px;">
                    <div class="features-table">
                        <div class="feature-row">
                            <span class="feature-label">Larghezza Minima (corpo):</span>
                            <span class="feature-value">{{ features.savignano.larghezza_minima|round(2) if features.savignano.larghezza_minima else 0 }} mm</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-label">Spessore Max (con margini):</span>
                            <span class="feature-value">{{ features.savignano.spessore_massimo_con_margini|round(2) if features.savignano.spessore_massimo_con_margini else 0 }} mm</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-label">Spessore Max (senza margini):</span>
                            <span class="feature-value">{{ features.savignano.spessore_massimo_senza_margini|round(2) if features.savignano.spessore_massimo_senza_margini else 0 }} mm</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-label">Tagliente Arco (misura):</span>
                            <span class="feature-value">{{ features.savignano.tagliente_arco_misura|round(2) if features.savignano.tagliente_arco_misura else 0 }} mm</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-label">Tagliente Corda (misura):</span>
                            <span class="feature-value">{{ features.savignano.tagliente_corda_misura|round(2) if features.savignano.tagliente_corda_misura else 0 }} mm</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-label">Inventory Number:</span>
                            <span class="feature-value">{{ features.savignano.inventory_number if features.savignano.inventory_number else 'N/A' }}</span>
                        </div>
                    </div>
                </div>
            </details>

            <!-- AI Archaeological Interpretation Button -->
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="generateSavignanoInterpretation()" id="savignano-ai-btn" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 24px; font-weight: 600;">
                    ü§ñ Generate AI Archaeological Interpretation
                </button>
            </div>

            <!-- AI Interpretation Section -->
            <div id="savignano-ai-interpretation" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                <h3 style="margin: 0 0 15px 0; color: #667eea;">ü§ñ AI Archaeological Analysis</h3>
                <div id="savignano-ai-content" style="color: #2d3748; line-height: 1.6;"></div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 13px; color: #718096;">
                    <em>Analysis by Claude Sonnet 4.5 with temperature 0.1 for factual accuracy</em>
                </div>
            </div>
        </div>

        <script>
        async function generateSavignanoInterpretation() {
            const btn = document.getElementById('savignano-ai-btn');
            const section = document.getElementById('savignano-ai-interpretation');
            const content = document.getElementById('savignano-ai-content');

            btn.disabled = true;
            btn.textContent = '‚è≥ Generating interpretation...';

            try {
                const response = await fetch('/web/savignano-ai-interpretation/{{ artifact_id }}');
                const data = await response.json();

                if (response.ok) {
                    content.innerHTML = data.interpretation.replace(/\n/g, '<br>');
                    section.style.display = 'block';
                    section.scrollIntoView({ behavior: 'smooth' });
                    btn.textContent = '‚úì Interpretation Generated';
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = 'ü§ñ Generate AI Archaeological Interpretation';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'ü§ñ Generate AI Archaeological Interpretation';
            }
        }
        </script>
        {% endif %}

        {% if tech_features %}
        <!-- Technological Analysis Section -->
        <div class="card full-width">
            <h2>üî¨ Technological Analysis</h2>
            <p style="color: #718096; margin-bottom: 20px;">Manufacturing techniques, wear patterns, and production methods analysis</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Production Method Card -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">‚öíÔ∏è Production Method</h3>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                        {{ tech_features.production_method|upper if tech_features.production_method else 'UNKNOWN' }}
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        Confidence: {{ (tech_features.production_confidence * 100)|round(1) if tech_features.production_confidence else 0 }}%
                    </div>
                </div>

                <!-- Hammering Card -->
                <div style="background: linear-gradient(135deg, #f687b3 0%, #c084fc 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">üî® Hammering Analysis</h3>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                        {{ 'YES' if tech_features.hammering_detected else 'NO' }}
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        Intensity: {{ tech_features.hammering_intensity|round(4) if tech_features.hammering_intensity else 0 }}
                        <br>(threshold: 0.60 for "forged")
                    </div>
                </div>

                <!-- Wear Analysis Card -->
                <div style="background: linear-gradient(135deg, #ed8936 0%, #f59e0b 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">üëÅÔ∏è Wear Analysis</h3>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                        {{ tech_features.wear_severity|upper if tech_features.wear_severity else 'NONE' }}
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        Edge Rounding: {{ tech_features.edge_rounding|round(4) if tech_features.edge_rounding else 0 }}
                    </div>
                </div>

                <!-- Edge Condition Card -->
                <div style="background: linear-gradient(135deg, #48bb78 0%, #10b981 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">‚öîÔ∏è Edge Condition</h3>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                        {{ tech_features.edge_sharpness|upper if tech_features.edge_sharpness else 'UNKNOWN' }}
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        Angle: {{ tech_features.edge_angle|round(2) if tech_features.edge_angle else 0 }}¬∞
                        <br>Usable: {{ 'YES' if tech_features.edge_usable else 'NO' }}
                    </div>
                </div>
            </div>

            <!-- Detailed Technical Data -->
            <details style="margin-top: 20px;">
                <summary style="cursor: pointer; font-weight: 600; color: #667eea; padding: 10px; background: #f7fafc; border-radius: 8px;">
                    üìä View Detailed Technical Data
                </summary>
                <div style="padding: 20px; background: #f7fafc; border-radius: 8px; margin-top: 10px;">
                    <div class="features-table">
                        <div class="feature-row">
                            <span class="feature-label">Casting Likely:</span>
                            <span class="feature-value">{{ 'YES' if tech_features.casting_likely else 'NO' }}</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-label">Casting Confidence:</span>
                            <span class="feature-value">{{ (tech_features.casting_confidence * 100)|round(1) if tech_features.casting_confidence else 0 }}%</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-label">Surface Smoothness:</span>
                            <span class="feature-value">{{ tech_features.surface_smoothness|round(4) if tech_features.surface_smoothness else 0 }}</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-label">Wear Detected:</span>
                            <span class="feature-value">{{ 'YES' if tech_features.wear_detected else 'NO' }}</span>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        {% if ai_interpretation and ai_interpretation.interpretation %}
        <!-- AI Archaeological Interpretation -->
        <div class="card full-width" style="background: linear-gradient(to bottom, #ffffff, #f7fafc);">
            <h2>ü§ñ Archaeological Interpretation (AI-Powered)</h2>
            <p style="color: #718096; margin-bottom: 20px; font-size: 14px;">
                Analysis by Claude Sonnet 4.5 with temperature 0.1 for factual accuracy
            </p>

            {% set interp = ai_interpretation.interpretation %}

            {% if interp.summary %}
            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #2d3748; font-size: 16px;">üìã Executive Summary</h3>
                <p style="color: #4a5568; line-height: 1.6; margin: 0;">{{ interp.summary }}</p>
            </div>
            {% endif %}

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                {% if interp.production_interpretation %}
                <details open>
                    <summary style="cursor: pointer; font-weight: 600; color: #667eea; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                        ‚öíÔ∏è Production Analysis
                    </summary>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Method:</strong> {{ interp.production_interpretation.method|upper }}<br>
                            <strong>Workshop Quality:</strong> {{ interp.production_interpretation.workshop_quality|replace('_', ' ')|title }}<br>
                            <strong>Confidence:</strong> {{ (interp.production_interpretation.confidence * 100)|round(1) }}%
                        </div>
                        <p style="color: #4a5568; font-size: 14px;">{{ interp.production_interpretation.description }}</p>
                        {% if interp.production_interpretation.evidence %}
                        <div style="margin-top: 10px; font-size: 13px;">
                            <strong>Evidence:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                {% for ev in interp.production_interpretation.evidence %}
                                <li>{{ ev }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </details>
                {% endif %}

                {% if interp.use_life %}
                <details open>
                    <summary style="cursor: pointer; font-weight: 600; color: #764ba2; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                        üîÑ Use-Life Analysis
                    </summary>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Intensity:</strong> {{ interp.use_life.intensity|title }}<br>
                            <strong>Duration:</strong> {{ interp.use_life.duration|replace('_', ' ')|title }}<br>
                            <strong>Maintenance:</strong> {{ interp.use_life.maintenance|upper }}
                        </div>
                        <p style="color: #4a5568; font-size: 14px;">{{ interp.use_life.description }}</p>
                        {% if interp.use_life.evidence %}
                        <div style="margin-top: 10px; font-size: 13px;">
                            <strong>Evidence:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                {% for ev in interp.use_life.evidence %}
                                <li>{{ ev }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </details>
                {% endif %}

                {% if interp.conservation_state %}
                <details open>
                    <summary style="cursor: pointer; font-weight: 600; color: #ed8936; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                        üõ°Ô∏è Conservation State
                    </summary>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Condition:</strong> {{ interp.conservation_state.condition|upper }}<br>
                            <strong>Degradation:</strong> {{ interp.conservation_state.degradation_type|replace('_', ' ')|title }}<br>
                            <strong>Functional:</strong> {{ 'YES' if interp.conservation_state.functional else 'NO' }}
                        </div>
                        <p style="color: #4a5568; font-size: 14px;">{{ interp.conservation_state.description }}</p>
                    </div>
                </details>
                {% endif %}

                {% if interp.archaeological_context %}
                <details open>
                    <summary style="cursor: pointer; font-weight: 600; color: #48bb78; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                        üèõÔ∏è Archaeological Context
                    </summary>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        {% if interp.archaeological_context.period_indicators %}
                        <div style="margin-bottom: 10px;">
                            <strong>Period Indicators:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
                                {% for ind in interp.archaeological_context.period_indicators %}
                                <li>{{ ind }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if interp.archaeological_context.comparative_notes %}
                        <p style="color: #4a5568; font-size: 14px;"><strong>Comparative:</strong> {{ interp.archaeological_context.comparative_notes }}</p>
                        {% endif %}
                        {% if interp.archaeological_context.research_value %}
                        <p style="margin-top: 10px;"><strong>Research Value:</strong> <span style="color: #667eea; font-weight: 600;">{{ interp.archaeological_context.research_value|upper }}</span></p>
                        {% endif %}
                        {% if interp.archaeological_context.recommendations %}
                        <div style="margin-top: 10px; font-size: 13px;">
                            <strong>Recommendations:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                {% for rec in interp.archaeological_context.recommendations %}
                                <li>{{ rec }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </details>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endif %}

        <div class="card full-width">
            <h2>Actions</h2>
            <div class="action-buttons">
                <button onclick="generateTechnicalDrawing('{{ artifact_id }}')" class="btn btn-primary">
                    üé® Disegno Tecnico
                </button>
                <button onclick="generatePDFReport('{{ artifact_id }}')" class="btn btn-primary">
                    üìÑ Generate PDF Report (with 3D renders)
                </button>
                <button onclick="findSimilar('{{ artifact_id }}')" class="btn btn-primary">
                    Find Similar Artifacts
                </button>
                <button onclick="classifyArtifact('{{ artifact_id }}')" class="btn btn-secondary">
                    Classify This Artifact
                </button>
                <button onclick="exportFeatures('{{ artifact_id }}')" class="btn btn-outline">
                    Export Features
                </button>
                <a href="{{ url_for('web.artifacts_page') }}" class="btn btn-outline">
                    ‚Üê Back to List
                </a>
            </div>
        </div>

        <div class="card full-width" id="similar-results" style="display:none;">
            <h2>Similar Artifacts</h2>
            <div id="similar-content"></div>
        </div>
    </div>
</div>

<!-- PDF Generation Progress Modal -->
<div id="pdf-progress-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <h3 style="margin: 0 0 20px 0; color: #333;">üìÑ Generating PDF Report</h3>

        <div id="pdf-progress-status" style="font-size: 14px; color: #666; margin-bottom: 15px; min-height: 20px;">
            Preparing...
        </div>

        <div style="background: #f0f0f0; border-radius: 10px; height: 24px; overflow: hidden; margin-bottom: 15px;">
            <div id="pdf-progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
        </div>

        <div id="pdf-progress-percent" style="text-align: center; font-weight: 600; color: #667eea; font-size: 18px;">
            0%
        </div>

        <div style="font-size: 12px; color: #999; text-align: center; margin-top: 10px;">
            <span id="pdf-elapsed-time">0</span>s elapsed
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function generateTechnicalDrawing(artifactId) {
    // Redirect to technical drawings page with pre-selected artifact
    window.location.href = '/web/drawings?artifact=' + artifactId;
}

async function generatePDFReport(artifactId) {
    // Confirm and generate comprehensive PDF report with 3D renders
    if (!confirm(`Generate comprehensive PDF report for ${artifactId}?\n\nThis will include:\n- Real 3D renders of the artifact\n- Technological analysis (production method, wear, hammering)\n- AI-powered archaeological interpretation\n- Morphometric features\n\nNote: Generation may take 10-30 seconds.`)) {
        return;
    }

    // Show progress modal
    const modal = document.getElementById('pdf-progress-modal');
    const progressBar = document.getElementById('pdf-progress-bar');
    const statusText = document.getElementById('pdf-progress-status');
    const percentText = document.getElementById('pdf-progress-percent');
    const elapsedText = document.getElementById('pdf-elapsed-time');

    modal.style.display = 'flex';
    progressBar.style.width = '0%';
    percentText.textContent = '0%';
    statusText.textContent = 'Preparing...';

    // Timer for elapsed time
    const startTime = Date.now();
    const timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        elapsedText.textContent = elapsed;
    }, 100);

    // Simulated progress updates
    const progressSteps = [
        { percent: 10, text: 'Loading mesh data...', delay: 500 },
        { percent: 25, text: 'Analyzing technological features...', delay: 2000 },
        { percent: 40, text: 'Running AI interpretation...', delay: 5000 },
        { percent: 60, text: 'Generating 3D renders...', delay: 4000 },
        { percent: 80, text: 'Creating PDF document...', delay: 2000 },
        { percent: 95, text: 'Finalizing...', delay: 1000 }
    ];

    let currentStep = 0;
    const updateProgress = () => {
        if (currentStep < progressSteps.length) {
            const step = progressSteps[currentStep];
            setTimeout(() => {
                progressBar.style.width = step.percent + '%';
                percentText.textContent = step.percent + '%';
                statusText.textContent = step.text;
                currentStep++;
                updateProgress();
            }, step.delay);
        }
    };
    updateProgress();

    // Disable button
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Generating...';
    btn.disabled = true;

    try {
        const response = await fetch(`/web/generate-tech-report/${artifactId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                include_morphometric: true
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        // Complete progress
        progressBar.style.width = '100%';
        percentText.textContent = '100%';
        statusText.textContent = '‚úÖ PDF generated successfully!';

        // Download the PDF
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tech_report_${artifactId}.pdf`;
        a.click();
        URL.revokeObjectURL(url);

        // Close modal after short delay
        setTimeout(() => {
            modal.style.display = 'none';
        }, 1500);
    } catch (error) {
        statusText.textContent = `‚ùå Error: ${error.message}`;
        statusText.style.color = '#e53e3e';
        setTimeout(() => {
            modal.style.display = 'none';
            alert(`‚ùå Error generating PDF report: ${error.message}`);
        }, 2000);
    } finally {
        clearInterval(timerInterval);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function findSimilar(artifactId) {
    const resultsDiv = document.getElementById('similar-results');
    const contentDiv = document.getElementById('similar-content');

    resultsDiv.style.display = 'block';
    contentDiv.innerHTML = '<p>‚è≥ Searching for similar artifacts...</p>';

    try {
        const response = await fetch('/web/find-similar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query_id: artifactId,
                n_results: 10,
                metric: 'cosine',
                min_similarity: 0.5
            })
        });

        const data = await response.json();

        if (response.ok && data.results) {
            let html = '<div style="margin-top: 15px;">';
            html += `<p><strong>Found ${data.n_results} similar artifacts (excluding self):</strong></p>`;
            html += '<table class="feature-table" style="width: 100%; margin-top: 10px;">';
            html += '<thead><tr><th>Rank</th><th>Artifact ID</th><th>Similarity</th><th>Volume</th><th>Length</th><th>Actions</th></tr></thead>';
            html += '<tbody>';

            data.results.forEach((result, index) => {
                if (result.artifact_id !== artifactId) {  // Exclude the query artifact itself
                    const similarityPercent = (result.similarity_score * 100).toFixed(1);
                    const volume = result.features.volume ? result.features.volume.toFixed(2) : 'N/A';
                    const length = result.features.length ? result.features.length.toFixed(2) : 'N/A';

                    html += `<tr>
                        <td>${index + 1}</td>
                        <td><a href="/web/artifacts/${result.artifact_id}">${result.artifact_id}</a></td>
                        <td><span style="color: ${result.similarity_score > 0.8 ? '#10b981' : result.similarity_score > 0.6 ? '#f59e0b' : '#6b7280'}; font-weight: bold;">${similarityPercent}%</span></td>
                        <td>${volume} mm¬≥</td>
                        <td>${length} mm</td>
                        <td>
                            <a href="/web/viewer?artifact1=${artifactId}&artifact2=${result.artifact_id}" class="btn btn-sm btn-outline">Compare</a>
                        </td>
                    </tr>`;
                }
            });

            html += '</tbody></table></div>';
            contentDiv.innerHTML = html;
        } else {
            contentDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${data.error || 'Unknown error'}</p>`;
        }
    } catch (error) {
        contentDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${error.message}</p>`;
    }
}

function classifyArtifact(artifactId) {
    if (confirm('Classify ' + artifactId + ' using defined taxonomic classes?')) {
        window.location.href = '/web/taxonomy';
    }
}

function exportFeatures(artifactId) {
    const features = {{ features|tojson }};
    const dataStr = JSON.stringify(features, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

    const exportFileDefaultName = artifactId + '_features.json';

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}
</script>
{% endblock %}
