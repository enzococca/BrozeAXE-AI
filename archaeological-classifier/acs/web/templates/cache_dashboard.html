{% extends "base.html" %}

{% block title %}Cache Dashboard - Archaeological Classifier{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìä Cache Dashboard</h1>
    <p>Visualizza, cerca e aggrega i dati salvati nel database</p>
</div>

<!-- Help Section (collapsible) -->
<div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleHelp()">
        <h3 style="margin: 0;">‚ùì Come funziona il sistema di Cache</h3>
        <span id="help-toggle-icon" style="font-size: 1.5em;">‚ñº</span>
    </div>
    <div id="help-content" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
        <h4>üìù Cosa deve fare l'utente PRIMA di vedere dati qui:</h4>
        <ol style="margin: 10px 0; padding-left: 20px;">
            <li><strong>Caricare artefatti</strong> - Vai su Upload e carica le mesh 3D (.obj)</li>
            <li><strong>Estrarre features</strong> - Vai su Savignano Analysis per estrarre le misure morfometriche</li>
            <li><strong>Eseguire analisi</strong> - I dati vengono salvati automaticamente quando esegui:
                <ul style="margin: 5px 0;">
                    <li>üî¨ <strong>PCA/Clustering</strong> (Morphometric Analysis)</li>
                    <li>üîç <strong>Comparazioni</strong> (Compare o Find Similar)</li>
                    <li>üìÑ <strong>Report comprensivi</strong> (Savignano Comprehensive Report)</li>
                    <li>ü§ñ <strong>Interpretazioni AI</strong> (quando chiedi analisi all'AI)</li>
                </ul>
            </li>
        </ol>

        <h4 style="margin-top: 15px;">üìä Tipi di dati salvati:</h4>
        <table style="width: 100%; margin-top: 10px; font-size: 0.9em;">
            <tr><td>üî¨ <code>pca_analysis</code></td><td>Risultati PCA con componenti selezionate</td></tr>
            <tr><td>üìä <code>clustering_analysis</code></td><td>Risultati clustering con assegnazioni</td></tr>
            <tr><td>üî® <code>hammering_analysis</code></td><td>Analisi martellatura dal report</td></tr>
            <tr><td>üî• <code>casting_analysis</code></td><td>Analisi fusione dal report</td></tr>
            <tr><td>üìÑ <code>comprehensive_report</code></td><td>Report completo generato</td></tr>
            <tr><td>üè∫ <code>savignano_interpretation</code></td><td>Interpretazione AI Savignano</td></tr>
            <tr><td>‚öôÔ∏è <code>tech_analysis</code></td><td>Analisi tecnologica AI</td></tr>
            <tr><td>üîç <code>savignano_comparison</code></td><td>Comparazioni Savignano con AI</td></tr>
        </table>

        <h4 style="margin-top: 15px;">üí° Vantaggi della cache:</h4>
        <ul style="margin: 5px 0; padding-left: 20px;">
            <li>‚úÖ <strong>Risparmio token AI</strong> - Non rigenera analisi gi√† fatte</li>
            <li>‚úÖ <strong>Risposte immediate</strong> - Dati gi√† calcolati</li>
            <li>‚úÖ <strong>Ricerca e aggregazione</strong> - Trova pattern nei dati</li>
            <li>‚úÖ <strong>Export completo</strong> - Scarica tutto in JSON</li>
        </ul>
    </div>
</div>

<!-- Search/Query Bar - RAG Semantic Search -->
<div class="card" style="margin-bottom: 20px;">
    <h3>üîé Ricerca Semantica (RAG)</h3>
    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
        Cerca usando intelligenza artificiale in tutti i dati cached - comprende il significato, non solo parole chiave
    </p>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <input type="text" id="global-search" class="form-control"
               placeholder="Domanda naturale (es. 'Quali artefatti mostrano martellatura intensa?', 'SAV_001 analisi')..."
               style="flex: 1; min-width: 300px;" onkeyup="globalSearch(event)">
        <button class="btn btn-primary" onclick="executeGlobalSearch()" id="rag-search-btn">üîç Cerca</button>
        <button class="btn btn-secondary" onclick="clearGlobalSearch()">‚úñ Cancella</button>
    </div>
    <div style="margin-top: 10px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="rag-generate-answer" style="width: auto;">
            <span style="font-size: 0.9em;">ü§ñ Genera risposta AI</span>
        </label>
        <span id="rag-stats" style="font-size: 0.8em; color: #888;"></span>
    </div>
    <div id="global-search-results" style="margin-top: 15px; display: none;">
        <div id="rag-answer-section" style="display: none; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="margin: 0 0 10px 0; color: #667eea;">ü§ñ Risposta AI</h4>
            <div id="rag-answer-content" style="white-space: pre-wrap;"></div>
        </div>
        <h4>üìÑ Documenti rilevanti (<span id="results-count">0</span>):</h4>
        <div id="search-results-content"></div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="stat-card card" style="text-align: center; padding: 20px;">
        <h3 style="color: #667eea; font-size: 2em;" id="stat-ai-cache">-</h3>
        <p>Interpretazioni AI</p>
    </div>
    <div class="stat-card card" style="text-align: center; padding: 20px;">
        <h3 style="color: #48bb78; font-size: 2em;" id="stat-comparisons">-</h3>
        <p>Comparazioni</p>
    </div>
    <div class="stat-card card" style="text-align: center; padding: 20px;">
        <h3 style="color: #ed8936; font-size: 2em;" id="stat-features">-</h3>
        <p>Artefatti con Features</p>
    </div>
    <div class="stat-card card" style="text-align: center; padding: 20px;">
        <h3 style="color: #9f7aea; font-size: 2em;" id="stat-analyses">-</h3>
        <p>Analisi (PCA/Clustering)</p>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-bar" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <button class="btn btn-primary" onclick="exportAllData()">üì• Export Tutto (JSON)</button>
    <button class="btn btn-secondary" onclick="refreshStats()">üîÑ Aggiorna</button>
</div>

<!-- Tabs -->
<div class="tabs" style="margin-bottom: 20px;">
    <button class="tab-btn active" onclick="showTab('ai-cache')">ü§ñ Interpretazioni AI</button>
    <button class="tab-btn" onclick="showTab('comparisons')">üîç Comparazioni</button>
    <button class="tab-btn" onclick="showTab('analyses')">üìà Analisi</button>
    <button class="tab-btn" onclick="showTab('aggregation')">üìä Aggregazione</button>
</div>

<!-- AI Cache Tab -->
<div id="ai-cache-tab" class="tab-content active">
    <div class="card">
        <h3>ü§ñ Interpretazioni AI Cached</h3>

        <!-- Filters -->
        <div class="filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <select id="ai-type-filter" class="form-control" style="max-width: 200px;" onchange="filterAICache()">
                <option value="">Tutti i tipi</option>
                <option value="savignano_interpretation">Savignano Interpretation</option>
                <option value="tech_analysis">Tech Analysis</option>
                <option value="hammering_analysis">Hammering Analysis</option>
                <option value="casting_analysis">Casting Analysis</option>
                <option value="comprehensive_report">Comprehensive Report</option>
                <option value="pca_analysis">PCA Analysis</option>
                <option value="clustering_analysis">Clustering Analysis</option>
            </select>
            <input type="text" id="ai-artifact-filter" class="form-control" placeholder="Cerca artefatto..."
                   style="max-width: 200px;" onkeyup="filterAICache()">
            <input type="text" id="ai-content-filter" class="form-control" placeholder="Cerca nel contenuto..."
                   style="max-width: 300px;" onkeyup="filterAICache()">
        </div>

        <div id="ai-cache-list" style="max-height: 500px; overflow-y: auto;">
            <p class="loading">Caricamento...</p>
        </div>
    </div>
</div>

<!-- Comparisons Tab -->
<div id="comparisons-tab" class="tab-content" style="display: none;">
    <div class="card">
        <h3>üîç Comparazioni Cached</h3>

        <!-- Filters -->
        <div class="filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <input type="text" id="comp-artifact-filter" class="form-control" placeholder="Cerca artefatto..."
                   style="max-width: 200px;" onkeyup="filterComparisons()">
            <select id="comp-similarity-filter" class="form-control" style="max-width: 200px;" onchange="filterComparisons()">
                <option value="">Tutte le similarit√†</option>
                <option value="high">Alta (>80%)</option>
                <option value="medium">Media (50-80%)</option>
                <option value="low">Bassa (<50%)</option>
            </select>
        </div>

        <div id="comparisons-list" style="max-height: 500px; overflow-y: auto;">
            <p class="loading">Caricamento...</p>
        </div>
    </div>
</div>

<!-- Analyses Tab -->
<div id="analyses-tab" class="tab-content" style="display: none;">
    <div class="card">
        <h3>üìà Analisi Cached (PCA, Clustering, Similarity Search)</h3>

        <!-- Filters -->
        <div class="filters" style="display: flex; gap: 10px; margin-bottom: 15px;">
            <select id="analysis-type-filter" class="form-control" style="max-width: 200px;" onchange="filterAnalyses()">
                <option value="">Tutti i tipi</option>
                <option value="pca">PCA</option>
                <option value="clustering">Clustering</option>
                <option value="similarity_search">Similarity Search</option>
            </select>
        </div>

        <div id="analyses-list" style="max-height: 500px; overflow-y: auto;">
            <p class="loading">Caricamento...</p>
        </div>
    </div>
</div>

<!-- Aggregation Tab -->
<div id="aggregation-tab" class="tab-content" style="display: none;">
    <div class="card">
        <h3>üìä Aggregazione e Report</h3>

        <!-- Aggregation Controls -->
        <div class="aggregation-controls" style="margin-bottom: 20px;">
            <h4>Raggruppa interpretazioni AI per:</h4>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="aggregateBy('artifact')">üì¶ Per Artefatto</button>
                <button class="btn btn-secondary" onclick="aggregateBy('type')">üè∑Ô∏è Per Tipo</button>
                <button class="btn btn-secondary" onclick="aggregateBy('date')">üìÖ Per Data</button>
            </div>
        </div>

        <div id="aggregation-results">
            <p style="color: #666;">Seleziona un tipo di aggregazione per visualizzare i risultati.</p>
        </div>

        <hr style="margin: 30px 0;">

        <!-- Summary Report Generator -->
        <h4>üìÑ Genera Report di Sintesi</h4>
        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
            Seleziona i dati da includere nel report e il formato di export.
        </p>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="include-pca" checked> üî¨ Analisi PCA
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="include-clustering" checked> üìä Clustering
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="include-interpretations" checked> ü§ñ Interpretazioni AI
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="include-comparisons" checked> üîç Comparazioni
                </label>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="generateSummaryReport('pdf')">üìÑ Export PDF</button>
                <button class="btn btn-success" onclick="generateSummaryReport('excel')">üìä Export Excel</button>
                <button class="btn btn-secondary" onclick="generateSummaryReport('json')">üì• Export JSON</button>
            </div>
        </div>

        <hr style="margin: 30px 0;">

        <!-- Charts Section -->
        <h4>üìà Visualizzazioni</h4>
        <div id="charts-section" style="margin-top: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- Cache Types Chart -->
                <div class="agg-card">
                    <h5>Distribuzione Tipi Cache</h5>
                    <div id="cache-types-chart" style="height: 200px;"></div>
                </div>
                <!-- Similarity Distribution -->
                <div class="agg-card">
                    <h5>Distribuzione Similarit√†</h5>
                    <div id="similarity-chart" style="height: 200px;"></div>
                </div>
            </div>
        </div>

        <hr style="margin: 30px 0;">

        <h4>üìä Statistiche Comparazioni</h4>
        <div id="comparison-stats" style="margin-top: 15px;">
            <p class="loading">Caricamento statistiche...</p>
        </div>
    </div>
</div>

<style>
.tab-btn {
    padding: 10px 20px;
    border: none;
    background: #e2e8f0;
    cursor: pointer;
    border-radius: 5px 5px 0 0;
    margin-right: 5px;
}
.tab-btn.active {
    background: #667eea;
    color: white;
}
.tab-content {
    background: white;
    border-radius: 0 5px 5px 5px;
}
.cache-item {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    background: #f7fafc;
}
.cache-item:hover {
    background: #edf2f7;
}
.cache-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.cache-item-content {
    font-size: 0.9em;
    color: #4a5568;
    max-height: 150px;
    overflow-y: auto;
    background: white;
    padding: 10px;
    border-radius: 5px;
    white-space: pre-wrap;
}
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}
.badge-primary { background: #667eea; color: white; }
.badge-success { background: #48bb78; color: white; }
.badge-warning { background: #ed8936; color: white; }
.badge-info { background: #4299e1; color: white; }
.similarity-bar {
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
}
.similarity-fill {
    height: 100%;
    border-radius: 4px;
}
.agg-card {
    background: #f7fafc;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}
.agg-card h5 {
    margin: 0 0 10px 0;
    color: #2d3748;
}
/* Formatted content styles */
.metric-row {
    padding: 5px 0;
    border-bottom: 1px solid #e2e8f0;
}
.metric-row:last-child {
    border-bottom: none;
}
.metric-label {
    color: #718096;
    font-size: 0.9em;
}
.formatted-text {
    line-height: 1.6;
}
.cache-item-content.formatted {
    white-space: normal;
}
/* Chart bars */
.chart-bar {
    height: 20px;
    border-radius: 4px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
}
.chart-bar-fill {
    height: 100%;
    border-radius: 4px;
    display: flex;
    align-items: center;
    padding-left: 8px;
    color: white;
    font-size: 0.8em;
    font-weight: bold;
}
.chart-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}
.chart-legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.85em;
}
.chart-legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}
.btn-success {
    background: #48bb78;
    color: white;
    border: none;
}
.btn-success:hover {
    background: #38a169;
}
</style>

<script>
let allAICache = [];
let allComparisons = [];
let allAnalyses = [];

// Load all data on page load
document.addEventListener('DOMContentLoaded', async () => {
    await refreshStats();
    await loadAllData();
});

async function refreshStats() {
    try {
        const response = await fetch('/web/cache-statistics');
        const data = await response.json();

        // Count AI cache entries
        let aiTotal = 0;
        if (data.ai_cache) {
            for (const [type, count] of Object.entries(data.ai_cache)) {
                aiTotal += count;
            }
        }
        document.getElementById('stat-ai-cache').textContent = aiTotal;
        document.getElementById('stat-comparisons').textContent = data.comparisons_count || 0;
        document.getElementById('stat-features').textContent = data.artifacts_with_features || 0;

        // Count analyses
        let analysesTotal = 0;
        if (data.analysis_results) {
            for (const [type, count] of Object.entries(data.analysis_results)) {
                analysesTotal += count;
            }
        }
        document.getElementById('stat-analyses').textContent = analysesTotal;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadAllData() {
    // Load AI cache
    try {
        const aiResponse = await fetch('/web/all-ai-cache');
        const aiData = await aiResponse.json();
        allAICache = aiData.entries || [];
        renderAICache(allAICache);
    } catch (error) {
        console.error('Error loading AI cache:', error);
    }

    // Load comparisons
    try {
        const compResponse = await fetch('/web/all-comparisons');
        const compData = await compResponse.json();
        allComparisons = compData.comparisons || [];
        renderComparisons(allComparisons);
    } catch (error) {
        console.error('Error loading comparisons:', error);
    }

    // Load analyses
    try {
        const analysesResponse = await fetch('/web/all-analyses?limit=50');
        const analysesData = await analysesResponse.json();
        allAnalyses = analysesData.results || [];
        renderAnalyses(allAnalyses);
    } catch (error) {
        console.error('Error loading analyses:', error);
    }

    // Load comparison stats for aggregation
    loadComparisonStats();
}

// Format content based on cache type for nice display
function formatCacheContent(content, cacheType) {
    if (typeof content === 'string') {
        // Already a string - format as paragraphs
        return `<div class="formatted-text">${content.replace(/\n/g, '<br>')}</div>`;
    }

    // Handle different cache types
    switch (cacheType) {
        case 'pca_analysis':
            return formatPCAContent(content);
        case 'clustering_analysis':
            return formatClusteringContent(content);
        case 'comprehensive_report':
            return formatReportContent(content);
        case 'hammering_analysis':
        case 'casting_analysis':
            return formatAnalysisContent(content);
        default:
            // Generic object formatting
            return formatGenericContent(content);
    }
}

function formatPCAContent(data) {
    let html = '<div class="pca-summary">';

    if (data.n_components) {
        html += `<div class="metric-row"><span class="metric-label">Componenti selezionate:</span> <strong>${data.n_components}</strong></div>`;
    }
    if (data.explained_variance_ratio) {
        const variance = (data.explained_variance_ratio * 100).toFixed(1);
        html += `<div class="metric-row"><span class="metric-label">Varianza spiegata:</span> <strong>${variance}%</strong></div>`;
    }
    if (data.artifacts && Array.isArray(data.artifacts)) {
        html += `<div class="metric-row"><span class="metric-label">Artefatti analizzati:</span> <strong>${data.artifacts.length}</strong></div>`;
        html += `<div class="artifacts-list" style="margin-top: 10px; font-size: 0.85em; color: #666;">`;
        html += data.artifacts.slice(0, 10).join(', ');
        if (data.artifacts.length > 10) html += ` <em>...e altri ${data.artifacts.length - 10}</em>`;
        html += '</div>';
    }
    if (data.selection_criteria) {
        html += `<div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 4px;">`;
        html += `<strong>Criterio di selezione:</strong> ${data.selection_criteria}`;
        html += '</div>';
    }

    html += '</div>';
    return html;
}

function formatClusteringContent(data) {
    let html = '<div class="clustering-summary">';

    if (data.n_clusters) {
        html += `<div class="metric-row"><span class="metric-label">Cluster identificati:</span> <strong>${data.n_clusters}</strong></div>`;
    }
    if (data.silhouette_score !== undefined) {
        const score = (data.silhouette_score * 100).toFixed(1);
        const quality = data.silhouette_score > 0.5 ? 'Buona' : data.silhouette_score > 0.25 ? 'Discreta' : 'Bassa';
        html += `<div class="metric-row"><span class="metric-label">Qualit√† (Silhouette):</span> <strong>${score}%</strong> <span class="badge badge-${data.silhouette_score > 0.5 ? 'success' : 'warning'}">${quality}</span></div>`;
    }
    if (data.cluster_sizes && typeof data.cluster_sizes === 'object') {
        html += `<div style="margin-top: 10px;"><strong>Distribuzione cluster:</strong></div>`;
        html += '<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">';
        for (const [cluster, size] of Object.entries(data.cluster_sizes)) {
            html += `<span class="badge badge-info">Cluster ${cluster}: ${size}</span>`;
        }
        html += '</div>';
    }
    if (data.methodology) {
        html += `<div style="margin-top: 10px; font-size: 0.85em; color: #666;">${data.methodology}</div>`;
    }

    html += '</div>';
    return html;
}

function formatReportContent(data) {
    let html = '<div class="report-summary">';

    if (data.artifact_id) {
        html += `<div class="metric-row"><strong>Artefatto:</strong> ${data.artifact_id}</div>`;
    }
    if (data.summary) {
        html += `<div style="margin-top: 10px;">${data.summary.substring(0, 300)}...</div>`;
    }
    if (data.sections && Array.isArray(data.sections)) {
        html += `<div style="margin-top: 10px;"><strong>Sezioni:</strong> ${data.sections.join(', ')}</div>`;
    }

    html += '</div>';
    return html;
}

function formatAnalysisContent(data) {
    let html = '<div class="analysis-summary">';

    for (const [key, value] of Object.entries(data)) {
        if (typeof value === 'string' && value.length > 0) {
            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<div class="metric-row"><span class="metric-label">${label}:</span> ${value.substring(0, 200)}${value.length > 200 ? '...' : ''}</div>`;
        } else if (typeof value === 'number') {
            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<div class="metric-row"><span class="metric-label">${label}:</span> <strong>${value}</strong></div>`;
        }
    }

    html += '</div>';
    return html;
}

function formatGenericContent(data) {
    let html = '<div class="generic-content">';

    const entries = Object.entries(data).slice(0, 8);
    for (const [key, value] of entries) {
        const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        let displayValue = value;

        if (typeof value === 'object' && value !== null) {
            if (Array.isArray(value)) {
                displayValue = value.length + ' items';
            } else {
                displayValue = Object.keys(value).length + ' properties';
            }
        } else if (typeof value === 'string' && value.length > 100) {
            displayValue = value.substring(0, 100) + '...';
        }

        html += `<div class="metric-row"><span class="metric-label">${label}:</span> ${displayValue}</div>`;
    }

    if (Object.keys(data).length > 8) {
        html += `<div style="color: #666; font-size: 0.85em; margin-top: 5px;">...e altre ${Object.keys(data).length - 8} propriet√†</div>`;
    }

    html += '</div>';
    return html;
}

function renderAICache(items) {
    const container = document.getElementById('ai-cache-list');

    if (items.length === 0) {
        container.innerHTML = '<p style="color: #666;">Nessuna interpretazione AI cached.</p>';
        return;
    }

    container.innerHTML = items.map(item => {
        const typeLabels = {
            'savignano_interpretation': 'Savignano Interp.',
            'tech_analysis': 'Tech Analysis',
            'hammering_analysis': 'Hammering',
            'casting_analysis': 'Casting',
            'comprehensive_report': 'Report Completo',
            'pca_analysis': 'PCA Analysis',
            'clustering_analysis': 'Clustering'
        };
        const typeLabel = typeLabels[item.cache_type] || item.cache_type;
        const formattedContent = formatCacheContent(item.content, item.cache_type);
        const rawContent = typeof item.content === 'string' ? item.content : JSON.stringify(item.content, null, 2);

        return `
            <div class="cache-item" data-artifact="${item.artifact_id}" data-type="${item.cache_type}">
                <div class="cache-item-header">
                    <div>
                        <strong>${item.artifact_id}</strong>
                        <span class="badge badge-primary">${typeLabel}</span>
                    </div>
                    <small style="color: #666;">${new Date(item.created_date).toLocaleDateString('it-IT')}</small>
                </div>
                <div class="cache-item-content formatted">${formattedContent}</div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-sm btn-secondary" onclick="viewFullContent('${item.artifact_id}', '${item.cache_type}')">
                        üëÅÔ∏è Vedi Tutto
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="copyContent(this)" data-content="${encodeURIComponent(rawContent)}">
                        üìã Copia
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function renderComparisons(items) {
    const container = document.getElementById('comparisons-list');

    if (items.length === 0) {
        container.innerHTML = '<p style="color: #666;">Nessuna comparazione cached.</p>';
        return;
    }

    container.innerHTML = items.map(item => {
        const similarity = item.similarity_score * 100;
        const barColor = similarity > 80 ? '#48bb78' : similarity > 50 ? '#ed8936' : '#e53e3e';

        return `
            <div class="cache-item" data-artifact1="${item.artifact1_id}" data-artifact2="${item.artifact2_id}" data-similarity="${similarity}">
                <div class="cache-item-header">
                    <div>
                        <strong>${item.artifact1_id}</strong> ‚ÜîÔ∏è <strong>${item.artifact2_id}</strong>
                    </div>
                    <span class="badge ${similarity > 80 ? 'badge-success' : similarity > 50 ? 'badge-warning' : 'badge-info'}">
                        ${similarity.toFixed(1)}% simili
                    </span>
                </div>
                <div class="similarity-bar">
                    <div class="similarity-fill" style="width: ${similarity}%; background: ${barColor};"></div>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    ${new Date(item.comparison_date).toLocaleDateString('it-IT')}
                </small>
            </div>
        `;
    }).join('');
}

function renderAnalyses(items) {
    const container = document.getElementById('analyses-list');

    if (items.length === 0) {
        container.innerHTML = '<p style="color: #666;">Nessuna analisi cached.</p>';
        return;
    }

    container.innerHTML = items.map(item => {
        const typeLabel = item.analysis_type === 'pca' ? 'PCA' :
                         item.analysis_type === 'clustering' ? 'Clustering' :
                         item.analysis_type === 'similarity_search' ? 'Similarity Search' : item.analysis_type;
        const artifacts = item.artifact_ids || [];

        return `
            <div class="cache-item" data-type="${item.analysis_type}">
                <div class="cache-item-header">
                    <span class="badge badge-info">${typeLabel}</span>
                    <small style="color: #666;">${new Date(item.analysis_date).toLocaleDateString('it-IT')}</small>
                </div>
                <p style="margin: 5px 0; font-size: 0.9em;">
                    <strong>Artefatti coinvolti:</strong> ${artifacts.length}
                </p>
                <p style="margin: 5px 0; font-size: 0.85em; color: #666;">
                    ${artifacts.slice(0, 5).join(', ')}${artifacts.length > 5 ? ', ...' : ''}
                </p>
            </div>
        `;
    }).join('');
}

function filterAICache() {
    const typeFilter = document.getElementById('ai-type-filter').value.toLowerCase();
    const artifactFilter = document.getElementById('ai-artifact-filter').value.toLowerCase();
    const contentFilter = document.getElementById('ai-content-filter').value.toLowerCase();

    const filtered = allAICache.filter(item => {
        const matchType = !typeFilter || item.cache_type.toLowerCase().includes(typeFilter);
        const matchArtifact = !artifactFilter || item.artifact_id.toLowerCase().includes(artifactFilter);
        const content = typeof item.content === 'string' ? item.content : JSON.stringify(item.content);
        const matchContent = !contentFilter || content.toLowerCase().includes(contentFilter);
        return matchType && matchArtifact && matchContent;
    });

    renderAICache(filtered);
}

function filterComparisons() {
    const artifactFilter = document.getElementById('comp-artifact-filter').value.toLowerCase();
    const similarityFilter = document.getElementById('comp-similarity-filter').value;

    const filtered = allComparisons.filter(item => {
        const matchArtifact = !artifactFilter ||
            item.artifact1_id.toLowerCase().includes(artifactFilter) ||
            item.artifact2_id.toLowerCase().includes(artifactFilter);

        let matchSimilarity = true;
        const sim = item.similarity_score * 100;
        if (similarityFilter === 'high') matchSimilarity = sim > 80;
        else if (similarityFilter === 'medium') matchSimilarity = sim >= 50 && sim <= 80;
        else if (similarityFilter === 'low') matchSimilarity = sim < 50;

        return matchArtifact && matchSimilarity;
    });

    renderComparisons(filtered);
}

function filterAnalyses() {
    const typeFilter = document.getElementById('analysis-type-filter').value;

    const filtered = allAnalyses.filter(item => {
        return !typeFilter || item.analysis_type === typeFilter;
    });

    renderAnalyses(filtered);
}

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    // Show selected tab
    document.getElementById(tabName + '-tab').style.display = 'block';
    event.target.classList.add('active');
}

function aggregateBy(groupBy) {
    const container = document.getElementById('aggregation-results');

    if (groupBy === 'artifact') {
        // Group by artifact
        const grouped = {};
        allAICache.forEach(item => {
            if (!grouped[item.artifact_id]) grouped[item.artifact_id] = [];
            grouped[item.artifact_id].push(item);
        });

        container.innerHTML = Object.entries(grouped).map(([artifact, items]) => `
            <div class="agg-card">
                <h5>üì¶ ${artifact}</h5>
                <p>${items.length} interpretazione/i cached</p>
                <ul style="margin: 0; padding-left: 20px;">
                    ${items.map(i => `<li>${i.cache_type} - ${new Date(i.created_date).toLocaleDateString('it-IT')}</li>`).join('')}
                </ul>
            </div>
        `).join('');

    } else if (groupBy === 'type') {
        // Group by type
        const grouped = {};
        allAICache.forEach(item => {
            if (!grouped[item.cache_type]) grouped[item.cache_type] = [];
            grouped[item.cache_type].push(item);
        });

        container.innerHTML = Object.entries(grouped).map(([type, items]) => `
            <div class="agg-card">
                <h5>üè∑Ô∏è ${type}</h5>
                <p>${items.length} interpretazione/i</p>
                <p style="font-size: 0.9em; color: #666;">
                    Artefatti: ${items.map(i => i.artifact_id).join(', ')}
                </p>
            </div>
        `).join('');

    } else if (groupBy === 'date') {
        // Group by date (month)
        const grouped = {};
        allAICache.forEach(item => {
            const date = new Date(item.created_date);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(item);
        });

        container.innerHTML = Object.entries(grouped).sort().reverse().map(([date, items]) => `
            <div class="agg-card">
                <h5>üìÖ ${date}</h5>
                <p>${items.length} interpretazione/i generate</p>
            </div>
        `).join('');
    }
}

function loadComparisonStats() {
    const container = document.getElementById('comparison-stats');

    if (allComparisons.length === 0) {
        container.innerHTML = '<p style="color: #666;">Nessuna comparazione disponibile.</p>';
        return;
    }

    // Calculate stats
    const similarities = allComparisons.map(c => c.similarity_score * 100);
    const avg = similarities.reduce((a, b) => a + b, 0) / similarities.length;
    const max = Math.max(...similarities);
    const min = Math.min(...similarities);

    // Find most compared artifacts
    const artifactCounts = {};
    allComparisons.forEach(c => {
        artifactCounts[c.artifact1_id] = (artifactCounts[c.artifact1_id] || 0) + 1;
        artifactCounts[c.artifact2_id] = (artifactCounts[c.artifact2_id] || 0) + 1;
    });
    const topArtifacts = Object.entries(artifactCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            <div class="agg-card" style="text-align: center;">
                <h5>Media</h5>
                <p style="font-size: 1.5em; color: #667eea; margin: 0;">${avg.toFixed(1)}%</p>
            </div>
            <div class="agg-card" style="text-align: center;">
                <h5>Max</h5>
                <p style="font-size: 1.5em; color: #48bb78; margin: 0;">${max.toFixed(1)}%</p>
            </div>
            <div class="agg-card" style="text-align: center;">
                <h5>Min</h5>
                <p style="font-size: 1.5em; color: #e53e3e; margin: 0;">${min.toFixed(1)}%</p>
            </div>
        </div>
        <div class="agg-card" style="margin-top: 15px;">
            <h5>üèÜ Artefatti pi√π comparati</h5>
            <ol style="margin: 0; padding-left: 20px;">
                ${topArtifacts.map(([artifact, count]) => `<li>${artifact}: ${count} comparazioni</li>`).join('')}
            </ol>
        </div>
    `;
}

async function viewFullContent(artifactId, cacheType) {
    const item = allAICache.find(i => i.artifact_id === artifactId && i.cache_type === cacheType);
    if (item) {
        const content = typeof item.content === 'string' ? item.content : JSON.stringify(item.content, null, 2);
        alert(content); // Simple alert, could be replaced with modal
    }
}

function copyContent(button) {
    const content = decodeURIComponent(button.dataset.content);
    navigator.clipboard.writeText(content).then(() => {
        button.textContent = '‚úì Copiato!';
        setTimeout(() => button.textContent = 'üìã Copia', 2000);
    });
}

async function exportAllData() {
    try {
        const response = await fetch('/web/export-all-data');
        const data = await response.json();

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `acs_cache_export_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        alert('Errore durante l\'export: ' + error.message);
    }
}

// Toggle help section visibility
function toggleHelp() {
    const content = document.getElementById('help-content');
    const icon = document.getElementById('help-toggle-icon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñ≤';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

// Global search - handle Enter key
function globalSearch(event) {
    if (event.key === 'Enter') {
        executeGlobalSearch();
    }
}

// Execute global search across all cached data
async function executeGlobalSearch() {
    const searchTerm = document.getElementById('global-search').value.trim();
    const resultsContainer = document.getElementById('global-search-results');
    const resultsContent = document.getElementById('search-results-content');
    const ragAnswerSection = document.getElementById('rag-answer-section');
    const ragAnswerContent = document.getElementById('rag-answer-content');
    const resultsCount = document.getElementById('results-count');
    const searchBtn = document.getElementById('rag-search-btn');
    const generateAnswer = document.getElementById('rag-generate-answer').checked;

    if (!searchTerm) {
        resultsContainer.style.display = 'none';
        return;
    }

    // Show loading state
    searchBtn.disabled = true;
    searchBtn.textContent = '‚è≥ Cercando...';
    resultsContainer.style.display = 'block';
    resultsContent.innerHTML = '<p class="loading">Ricerca semantica in corso...</p>';
    ragAnswerSection.style.display = 'none';

    try {
        const response = await AuthHelper.fetch('/web/rag-search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: searchTerm,
                top_k: 15,
                generate_answer: generateAnswer
            })
        });

        const data = await response.json();

        if (data.status !== 'success') {
            throw new Error(data.error || 'Ricerca fallita');
        }

        // Update RAG stats
        if (data.stats) {
            document.getElementById('rag-stats').textContent =
                `üìö ${data.stats.document_count} documenti indicizzati | Vocabolario: ${data.stats.vocabulary_size} termini`;
        }

        // Show AI answer if generated - with structured formatting
        if (data.answer) {
            ragAnswerSection.style.display = 'block';

            // Render markdown-like formatting
            let formattedAnswer = data.answer
                .replace(/## ([^\n]+)/g, '<h3 style="color: #667eea; margin: 15px 0 8px 0;">$1</h3>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/_([^_]+)_/g, '<em style="color: #718096;">$1</em>')
                .replace(/‚Ä¢ ([^\n]+)/g, '<li style="margin-left: 20px;">$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            ragAnswerContent.innerHTML = `<div style="line-height: 1.6;">${formattedAnswer}</div>`;

            // Show visualization if available
            if (data.visualization) {
                const viz = data.visualization;
                let vizHtml = '';

                if (viz.type === 'chart' && viz.data) {
                    vizHtml = `
                        <div style="margin-top: 20px; text-align: center;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üìä ${viz.description || 'Visualizzazione'}</h4>
                            <img src="${viz.data}" alt="Visualization" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                    `;
                } else if (viz.type === 'table' && viz.data) {
                    let tableHtml = '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                    tableHtml += '<thead><tr style="background: #f7fafc;">';
                    const headers = Object.keys(viz.data[0] || {});
                    headers.forEach(h => {
                        tableHtml += `<th style="padding: 10px; border: 1px solid #e2e8f0; text-align: left;">${h}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    viz.data.forEach(row => {
                        tableHtml += '<tr>';
                        headers.forEach(h => {
                            let val = row[h];
                            if (typeof val === 'number') val = val.toFixed ? val.toFixed(2) : val;
                            tableHtml += `<td style="padding: 8px; border: 1px solid #e2e8f0;">${val || '-'}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table>';
                    vizHtml = `
                        <div style="margin-top: 20px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üìã ${viz.description || 'Tabella'}</h4>
                            ${tableHtml}
                        </div>
                    `;
                } else if (viz.type === 'info') {
                    vizHtml = `
                        <div style="margin-top: 15px; padding: 10px; background: #fffaf0; border-radius: 8px; border-left: 4px solid #ed8936;">
                            <strong>‚ÑπÔ∏è ${viz.description || ''}</strong>
                            <p style="margin: 5px 0 0 0; color: #718096;">${viz.data}</p>
                        </div>
                    `;
                }

                if (vizHtml) {
                    ragAnswerContent.innerHTML += vizHtml;
                }
            }

            // Show visualization suggestion if AI recommended one but we couldn't generate it
            if (data.needs_visualization && !data.visualization && data.visualization_description) {
                ragAnswerContent.innerHTML += `
                    <div style="margin-top: 15px; padding: 10px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #48bb78;">
                        <strong>üí° Suggerimento visualizzazione:</strong>
                        <p style="margin: 5px 0 0 0; color: #718096;">${data.visualization_description}</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #48bb78;">
                            Tipo consigliato: <em>${data.visualization_type}</em>
                        </p>
                    </div>
                `;
            }
        } else {
            ragAnswerSection.style.display = 'none';
        }

        // Display results
        const results = data.results || [];
        resultsCount.textContent = results.length;

        if (results.length === 0) {
            resultsContent.innerHTML = `
                <p style="color: #666;">Nessun risultato semanticamente rilevante per "<strong>${searchTerm}</strong>"</p>
                <p style="font-size: 0.9em; color: #999;">Suggerimenti per la ricerca RAG:
                    <ul>
                        <li>Usa domande naturali (es. "Quali artefatti hanno martellatura?")</li>
                        <li>Cerca concetti archeologici (es. "analisi fusione", "cluster simili")</li>
                        <li>Combina termini (es. "SAV_001 interpretazione tecnologica")</li>
                    </ul>
                </p>
            `;
            return;
        }

        resultsContent.innerHTML = results.map(r => {
            const icon = r.type === 'ai_cache' ? 'ü§ñ' : 'üîç';
            const label = r.type === 'ai_cache'
                ? `${r.artifact_id} - ${formatCacheType(r.cache_type)}`
                : `${r.artifact1_id} ‚ÜîÔ∏è ${r.artifact2_id}`;
            const date = r.date ? new Date(r.date).toLocaleDateString('it-IT') : '';

            // Format content preview
            let preview = '';
            if (r.type === 'ai_cache') {
                const content = typeof r.content === 'string' ? r.content : JSON.stringify(r.content);
                preview = content.substring(0, 400) + (content.length > 400 ? '...' : '');
            } else {
                preview = `Similarit√†: ${(r.similarity_score * 100).toFixed(1)}%`;
            }

            return `
                <div class="cache-item" style="margin-bottom: 15px; border-left: 3px solid ${getScoreColor(r.score)};">
                    <div class="cache-item-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>${icon} ${label}</strong>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="background: ${getScoreColor(r.score)}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                ${r.score_pct} rilevanza
                            </span>
                            <small style="color: #666;">${date}</small>
                        </div>
                    </div>
                    <div style="font-size: 0.9em; color: #4a5568; margin-top: 8px; white-space: pre-wrap;">
                        ${preview}
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('RAG search error:', error);
        resultsContent.innerHTML = `
            <p style="color: #e53e3e;">Errore nella ricerca: ${error.message}</p>
            <p style="font-size: 0.9em;">Verifica che ci siano dati nella cache e riprova.</p>
        `;
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'üîç Cerca';
    }
}

// Get color based on relevance score
function getScoreColor(score) {
    if (score >= 0.7) return '#48bb78';  // High - green
    if (score >= 0.4) return '#ed8936';  // Medium - orange
    return '#a0aec0';  // Low - gray
}

// Format cache type for display
function formatCacheType(type) {
    const labels = {
        'savignano_interpretation': 'Interpretazione Savignano',
        'tech_analysis': 'Analisi Tecnologica',
        'hammering_analysis': 'Analisi Martellatura',
        'casting_analysis': 'Analisi Fusione',
        'comprehensive_report': 'Report Comprensivo',
        'pca_analysis': 'Analisi PCA',
        'clustering_analysis': 'Clustering'
    };
    return labels[type] || type;
}

// Highlight search term in text
function highlightText(text, searchTerm) {
    if (!searchTerm) return text;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<mark style="background: #fef08a; padding: 0 2px;">$1</mark>');
}

// Clear global search
function clearGlobalSearch() {
    document.getElementById('global-search').value = '';
    document.getElementById('global-search-results').style.display = 'none';
    document.getElementById('search-results-content').innerHTML = '';
    document.getElementById('rag-answer-section').style.display = 'none';
    document.getElementById('rag-answer-content').textContent = '';
    document.getElementById('results-count').textContent = '0';
}

// Generate summary report
async function generateSummaryReport(format) {
    const includePCA = document.getElementById('include-pca').checked;
    const includeClustering = document.getElementById('include-clustering').checked;
    const includeInterpretations = document.getElementById('include-interpretations').checked;
    const includeComparisons = document.getElementById('include-comparisons').checked;

    // Collect data based on selections
    const reportData = {
        generated: new Date().toISOString(),
        title: 'Report di Sintesi - Archaeological Classifier Cache',
        sections: []
    };

    if (includePCA) {
        const pcaItems = allAICache.filter(i => i.cache_type === 'pca_analysis');
        reportData.sections.push({
            name: 'Analisi PCA',
            count: pcaItems.length,
            items: pcaItems.map(i => ({
                artifact: i.artifact_id,
                date: i.created_date,
                data: i.content
            }))
        });
    }

    if (includeClustering) {
        const clusterItems = allAICache.filter(i => i.cache_type === 'clustering_analysis');
        reportData.sections.push({
            name: 'Clustering Analysis',
            count: clusterItems.length,
            items: clusterItems.map(i => ({
                artifact: i.artifact_id,
                date: i.created_date,
                data: i.content
            }))
        });
    }

    if (includeInterpretations) {
        const interpTypes = ['savignano_interpretation', 'tech_analysis', 'hammering_analysis', 'casting_analysis', 'comprehensive_report'];
        const interpItems = allAICache.filter(i => interpTypes.includes(i.cache_type));
        reportData.sections.push({
            name: 'Interpretazioni AI',
            count: interpItems.length,
            items: interpItems.map(i => ({
                artifact: i.artifact_id,
                type: i.cache_type,
                date: i.created_date,
                content: typeof i.content === 'string' ? i.content : JSON.stringify(i.content)
            }))
        });
    }

    if (includeComparisons) {
        reportData.sections.push({
            name: 'Comparazioni',
            count: allComparisons.length,
            items: allComparisons.map(c => ({
                artifact1: c.artifact1_id,
                artifact2: c.artifact2_id,
                similarity: (c.similarity_score * 100).toFixed(1) + '%',
                date: c.comparison_date
            }))
        });
    }

    // Export based on format
    if (format === 'json') {
        downloadJSON(reportData, 'cache_summary_report.json');
    } else if (format === 'excel') {
        downloadExcel(reportData);
    } else if (format === 'pdf') {
        downloadPDF(reportData);
    }
}

function downloadJSON(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function downloadExcel(data) {
    // Create CSV content (simplified Excel export)
    let csv = 'Report di Sintesi - Archaeological Classifier\n\n';

    for (const section of data.sections) {
        csv += `\n${section.name}\n`;
        csv += `Totale: ${section.count}\n`;

        if (section.items.length > 0) {
            // Get headers from first item
            const headers = Object.keys(section.items[0]);
            csv += headers.join(',') + '\n';

            for (const item of section.items) {
                const values = headers.map(h => {
                    let val = item[h];
                    if (typeof val === 'object') val = JSON.stringify(val);
                    // Escape quotes and commas
                    if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
                        val = '"' + val.replace(/"/g, '""') + '"';
                    }
                    return val;
                });
                csv += values.join(',') + '\n';
            }
        }
        csv += '\n';
    }

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cache_summary_report.csv';
    a.click();
    URL.revokeObjectURL(url);
}

function downloadPDF(data) {
    // Create printable HTML that opens in new window for PDF print
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Report di Sintesi - Archaeological Classifier</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                h2 { color: #4a5568; margin-top: 30px; }
                .section { margin-bottom: 30px; }
                .item { background: #f7fafc; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea; }
                .item-header { font-weight: bold; margin-bottom: 5px; }
                .item-content { color: #4a5568; font-size: 0.9em; }
                .stats { display: flex; gap: 20px; margin: 20px 0; }
                .stat-box { background: #667eea; color: white; padding: 20px; border-radius: 8px; text-align: center; }
                .stat-value { font-size: 2em; font-weight: bold; }
                .stat-label { font-size: 0.9em; opacity: 0.9; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: left; }
                th { background: #f7fafc; }
                @media print { body { margin: 20px; } }
            </style>
        </head>
        <body>
            <h1>üìä Report di Sintesi</h1>
            <p>Generato il: ${new Date().toLocaleString('it-IT')}</p>

            <div class="stats">
    `;

    // Add summary stats
    let totalItems = 0;
    for (const section of data.sections) {
        totalItems += section.count;
        html += `
            <div class="stat-box">
                <div class="stat-value">${section.count}</div>
                <div class="stat-label">${section.name}</div>
            </div>
        `;
    }

    html += `</div>`;

    // Add sections
    for (const section of data.sections) {
        html += `
            <div class="section">
                <h2>${section.name} (${section.count})</h2>
        `;

        if (section.items.length > 0) {
            // Create table for items
            const headers = Object.keys(section.items[0]);
            html += '<table><thead><tr>';
            for (const h of headers) {
                html += `<th>${h}</th>`;
            }
            html += '</tr></thead><tbody>';

            for (const item of section.items.slice(0, 50)) { // Limit to 50 items for PDF
                html += '<tr>';
                for (const h of headers) {
                    let val = item[h];
                    if (typeof val === 'object') val = JSON.stringify(val).substring(0, 100) + '...';
                    if (typeof val === 'string' && val.length > 200) val = val.substring(0, 200) + '...';
                    html += `<td>${val || '-'}</td>`;
                }
                html += '</tr>';
            }

            html += '</tbody></table>';

            if (section.items.length > 50) {
                html += `<p style="color: #666; font-style: italic;">...e altri ${section.items.length - 50} elementi</p>`;
            }
        }

        html += '</div>';
    }

    html += `
            <hr style="margin-top: 40px;">
            <p style="color: #666; font-size: 0.9em;">
                Archaeological Classifier - Cache Dashboard Report<br>
                Questo report √® stato generato automaticamente dal sistema di cache.
            </p>
        </body>
        </html>
    `;

    // Open in new window for printing
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = function() {
        printWindow.print();
    };
}

// Render charts on aggregation tab load
function renderCharts() {
    renderCacheTypesChart();
    renderSimilarityChart();
}

function renderCacheTypesChart() {
    const container = document.getElementById('cache-types-chart');

    // Count by type
    const typeCounts = {};
    allAICache.forEach(item => {
        typeCounts[item.cache_type] = (typeCounts[item.cache_type] || 0) + 1;
    });

    const total = allAICache.length || 1;
    const colors = ['#667eea', '#48bb78', '#ed8936', '#e53e3e', '#4299e1', '#9f7aea', '#38b2ac'];

    let html = '';
    let i = 0;
    for (const [type, count] of Object.entries(typeCounts).sort((a, b) => b[1] - a[1])) {
        const pct = (count / total * 100).toFixed(0);
        const color = colors[i % colors.length];
        html += `
            <div class="chart-bar" style="background: #e2e8f0;">
                <div class="chart-bar-fill" style="width: ${pct}%; background: ${color}; min-width: 40px;">
                    ${count}
                </div>
            </div>
            <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">${type}</div>
        `;
        i++;
    }

    if (Object.keys(typeCounts).length === 0) {
        html = '<p style="color: #666; text-align: center;">Nessun dato disponibile</p>';
    }

    container.innerHTML = html;
}

function renderSimilarityChart() {
    const container = document.getElementById('similarity-chart');

    if (allComparisons.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">Nessuna comparazione disponibile</p>';
        return;
    }

    // Group by similarity ranges
    const ranges = { 'Alta (>80%)': 0, 'Media (50-80%)': 0, 'Bassa (<50%)': 0 };
    allComparisons.forEach(c => {
        const sim = c.similarity_score * 100;
        if (sim > 80) ranges['Alta (>80%)']++;
        else if (sim >= 50) ranges['Media (50-80%)']++;
        else ranges['Bassa (<50%)']++;
    });

    const total = allComparisons.length;
    const colors = { 'Alta (>80%)': '#48bb78', 'Media (50-80%)': '#ed8936', 'Bassa (<50%)': '#e53e3e' };

    let html = '';
    for (const [range, count] of Object.entries(ranges)) {
        const pct = (count / total * 100).toFixed(0);
        html += `
            <div class="chart-bar" style="background: #e2e8f0;">
                <div class="chart-bar-fill" style="width: ${pct}%; background: ${colors[range]}; min-width: 40px;">
                    ${count}
                </div>
            </div>
            <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">${range}</div>
        `;
    }

    container.innerHTML = html;
}

// Update showTab to render charts when aggregation tab is shown
const originalShowTab = showTab;
showTab = function(tabName) {
    originalShowTab(tabName);
    if (tabName === 'aggregation') {
        renderCharts();
    }
};
</script>
{% endblock %}
