{% extends "base.html" %}

{% block title %}Upload Meshes - Archaeological Classifier{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Upload 3D Meshes</h1>
        <p class="subtitle">Upload OBJ, PLY, or STL files for analysis</p>
    </div>

    <div class="upload-container">
        <div class="card">
            <h2>Upload Files</h2>

            <!-- Project Selection -->
            <div class="form-group" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <label for="project-select" style="font-weight: bold; margin-bottom: 10px; display: block;">
                    üìÅ Select Project (optional)
                </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="project-select" class="form-control" style="flex: 1;">
                        <option value="">-- No Project (General Upload) --</option>
                    </select>
                    <button onclick="showCreateProjectDialog()" class="btn btn-primary" type="button">
                        + New Project
                    </button>
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    Artifacts will be associated with the selected project for better organization
                </small>
            </div>

            <div class="upload-zone" id="upload-zone">
                <div class="upload-icon">üì¶</div>
                <p class="upload-text">Drag and drop files here or click to browse</p>
                <p class="upload-hint">Supported formats: OBJ, PLY, STL</p>
                <input type="file" id="file-input" multiple accept=".obj,.ply,.stl" hidden>
                <button onclick="document.getElementById('file-input').click()" class="btn btn-primary">
                    Choose Files
                </button>
            </div>

            <div id="file-list" class="file-list"></div>

            <!-- Savignano Features Section -->
            <div class="form-group" style="margin-top: 20px; padding: 15px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="enable-savignano" onchange="toggleSavignanoOptions()" style="margin-right: 10px;">
                    <label for="enable-savignano" style="font-weight: bold; margin: 0;">
                        üó°Ô∏è Enable Savignano Analysis (Bronze Age Axes)
                    </label>
                </div>
                <small style="color: #666; display: block; margin-bottom: 15px;">
                    Extract specialized morphometric features for Bronze Age axes (tallone, incavo, margini rialzati, tagliente)
                </small>

                <div id="savignano-options" style="display: none;">
                    <!-- Mesh Units Selection -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            üìè Mesh Units
                        </label>
                        <select id="mesh-units" class="form-control" style="max-width: 200px;">
                            <option value="cm" selected>Centimeters (cm) - Default</option>
                            <option value="mm">Millimeters (mm)</option>
                            <option value="m">Meters (m)</option>
                            <option value="in">Inches (in)</option>
                        </select>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Select the unit your 3D mesh is exported in. Most archaeological scans are in cm.
                        </small>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            ‚öñÔ∏è Weights (Optional but Recommended)
                        </label>

                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="weight-mode" value="none" checked onchange="updateWeightMode()" style="margin-right: 5px;">
                                No weights
                            </label>
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="weight-mode" value="manual" onchange="updateWeightMode()" style="margin-right: 5px;">
                                Manual input
                            </label>
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="weight-mode" value="file" onchange="updateWeightMode()" style="margin-right: 5px;">
                                From file
                            </label>
                        </div>

                        <!-- Manual weight input hint -->
                        <div id="manual-weight-hint" style="display: none; padding: 10px; background: #e8f5e9; border-radius: 6px; border-left: 3px solid #4caf50; margin-bottom: 10px;">
                            <p style="margin: 0; font-size: 14px; color: #2e7d32;">
                                ‚öñÔ∏è <strong>Manual weight input enabled:</strong> Add your 3D files above, then enter the weight (in grams) for each file in the file list.
                            </p>
                        </div>

                        <!-- Weight file input (shown when "From file" is selected) -->
                        <div id="weight-file-input" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-size: 14px;">
                                Upload weights file (Excel, CSV, JSON, or DOCX):
                            </label>
                            <input type="file" id="weights-file" accept=".xlsx,.xls,.csv,.json,.docx" class="form-control" style="max-width: 400px;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Excel/CSV: columns 'artifact_id' and 'weight' | JSON: {"974": 387.0} | DOCX: text patterns like "974: 387g"
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Texture/Material Files Section -->
            <div class="form-group" style="margin-top: 20px; padding: 15px; background: #fff5eb; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 24px; margin-right: 10px;">üé®</span>
                    <label style="font-weight: bold; margin: 0;">
                        Textures & Materials (Optional)
                    </label>
                </div>
                <small style="color: #666; display: block; margin-bottom: 15px;">
                    Upload MTL and texture files (PNG/JPG) to display colored/textured 3D models
                </small>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- MTL File -->
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            üìÑ MTL Material File
                        </label>
                        <input type="file" id="mtl-file" accept=".mtl" class="form-control">
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Material file exported with OBJ
                        </small>
                    </div>

                    <!-- Texture Files -->
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            üñºÔ∏è Texture Images
                        </label>
                        <input type="file" id="texture-files" accept=".png,.jpg,.jpeg,.tga,.bmp" multiple class="form-control">
                        <small style="color: #666; margin-top: 5px; display: block;">
                            PNG, JPG textures (can select multiple)
                        </small>
                    </div>
                </div>

                <div id="texture-preview" style="margin-top: 10px; display: none;">
                    <p style="font-size: 13px; color: #059669; margin: 0;">
                        ‚úì <span id="texture-count">0</span> texture file(s) selected
                    </p>
                </div>
            </div>

            <div class="upload-actions">
                <button onclick="uploadFiles()" id="upload-btn" class="btn btn-success" disabled>
                    Upload Selected Files
                </button>
                <button onclick="clearFiles()" class="btn btn-outline">
                    Clear All
                </button>
            </div>
        </div>

        <div class="card">
            <h2>Upload Progress</h2>
            <div id="progress-container">
                <p class="text-muted">No uploads in progress</p>
            </div>
        </div>

        <div class="card full-width">
            <h2>Recently Uploaded</h2>
            <div id="recent-uploads">
                <p class="text-muted">No files uploaded yet</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedFiles = [];
let fileWeights = {};  // Store manual weights {filename: weight}

const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const fileList = document.getElementById('file-list');
const uploadBtn = document.getElementById('upload-btn');

// Drag and drop handlers
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('drag-over');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('drag-over');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');

    const files = Array.from(e.dataTransfer.files);
    addFiles(files);
});

fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    addFiles(files);
});

// Texture file preview
document.getElementById('texture-files')?.addEventListener('change', (e) => {
    const count = e.target.files.length;
    const preview = document.getElementById('texture-preview');
    const countSpan = document.getElementById('texture-count');
    if (count > 0) {
        preview.style.display = 'block';
        countSpan.textContent = count;
    } else {
        preview.style.display = 'none';
    }
});

// MTL file preview
document.getElementById('mtl-file')?.addEventListener('change', (e) => {
    const preview = document.getElementById('texture-preview');
    const textureCount = document.getElementById('texture-files')?.files?.length || 0;
    const mtlCount = e.target.files.length;
    if (mtlCount > 0 || textureCount > 0) {
        preview.style.display = 'block';
        document.getElementById('texture-count').textContent = `MTL + ${textureCount} texture`;
    }
});

function addFiles(files) {
    const validExtensions = ['.obj', '.ply', '.stl'];

    files.forEach(file => {
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        if (validExtensions.includes(ext)) {
            selectedFiles.push(file);
        } else {
            alert(`Invalid file type: ${file.name}. Only OBJ, PLY, STL allowed.`);
        }
    });

    updateFileList();
}

function updateFileList() {
    if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        uploadBtn.disabled = true;
        return;
    }

    uploadBtn.disabled = false;

    fileList.innerHTML = '<h3>Selected Files (' + selectedFiles.length + ')</h3>';

    const weightMode = document.querySelector('input[name="weight-mode"]:checked')?.value || 'none';
    const showManualWeight = weightMode === 'manual';

    selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';

        let weightInput = '';
        if (showManualWeight) {
            const currentWeight = fileWeights[file.name] || '';
            weightInput = `
                <input type="number"
                       placeholder="Weight (g)"
                       value="${currentWeight}"
                       onchange="updateWeight('${file.name}', this.value)"
                       style="width: 100px; padding: 4px 8px; margin-left: 10px; border: 1px solid #ddd; border-radius: 4px;"
                       step="0.1"
                       min="0">
            `;
        }

        fileItem.innerHTML = `
            <span class="file-name">üìÑ ${file.name}</span>
            <span class="file-size">${formatFileSize(file.size)}</span>
            ${weightInput}
            <button onclick="removeFile(${index})" class="btn-remove">‚úï</button>
        `;
        fileList.appendChild(fileItem);
    });
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}

function clearFiles() {
    selectedFiles = [];
    fileInput.value = '';
    updateFileList();
}

async function uploadFiles() {
    if (selectedFiles.length === 0) return;

    const progressContainer = document.getElementById('progress-container');
    progressContainer.innerHTML = '<h3>Uploading...</h3>';

    const results = [];

    // Check Savignano options
    const enableSavignano = document.getElementById('enable-savignano')?.checked || false;
    const weightMode = document.querySelector('input[name="weight-mode"]:checked')?.value || 'none';

    // Prepare weights file if provided
    let weightsFileData = null;
    if (enableSavignano && weightMode === 'file') {
        const weightsFileInput = document.getElementById('weights-file');
        if (weightsFileInput.files.length > 0) {
            weightsFileData = weightsFileInput.files[0];
        }
    }

    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];

        const progressItem = document.createElement('div');
        progressItem.className = 'progress-item';
        progressItem.innerHTML = `
            <div class="progress-info">
                <span>${file.name}</span>
                <span class="progress-status">Uploading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
        `;
        progressContainer.appendChild(progressItem);

        const progressFill = progressItem.querySelector('.progress-fill');
        const progressStatus = progressItem.querySelector('.progress-status');

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('artifact_id', file.name.split('.')[0]);

            // Add project_id if selected
            const projectSelect = document.getElementById('project-select');
            if (projectSelect.value) {
                formData.append('project_id', projectSelect.value);
            }

            // Add mesh units (always include for 3D viewer scaling)
            const meshUnits = document.getElementById('mesh-units')?.value || 'cm';
            formData.append('mesh_units', meshUnits);

            // Add Savignano options
            if (enableSavignano) {
                formData.append('enable_savignano', 'true');

                // Add weight if available
                if (weightMode === 'manual' && fileWeights[file.name]) {
                    formData.append('weight', fileWeights[file.name]);
                }

                // Add weights file (only on first iteration to avoid duplicate uploads)
                if (weightMode === 'file' && weightsFileData && i === 0) {
                    formData.append('weights_file', weightsFileData);
                }
            }

            // Add MTL file if provided (only with first mesh file)
            if (i === 0) {
                const mtlFileInput = document.getElementById('mtl-file');
                if (mtlFileInput && mtlFileInput.files.length > 0) {
                    formData.append('mtl_file', mtlFileInput.files[0]);
                }

                // Add texture files if provided
                const textureFilesInput = document.getElementById('texture-files');
                if (textureFilesInput && textureFilesInput.files.length > 0) {
                    for (const texFile of textureFilesInput.files) {
                        formData.append('texture_files', texFile);
                    }
                }
            }

            // Use XMLHttpRequest for progress tracking
            const result = await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();

                // Track upload progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressFill.style.width = percentComplete + '%';
                        progressStatus.textContent = `Uploading... ${Math.round(percentComplete)}%`;
                    }
                });

                // Handle completion
                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            resolve(JSON.parse(xhr.responseText));
                        } catch (e) {
                            reject(new Error('Invalid JSON response'));
                        }
                    } else {
                        try {
                            const error = JSON.parse(xhr.responseText);
                            reject(new Error(error.error || 'Upload failed'));
                        } catch (e) {
                            reject(new Error(`Upload failed with status ${xhr.status}`));
                        }
                    }
                });

                xhr.addEventListener('error', () => {
                    reject(new Error('Network error'));
                });

                xhr.addEventListener('abort', () => {
                    reject(new Error('Upload cancelled'));
                });

                // Open connection FIRST
                xhr.open('POST', '/web/upload-mesh');

                // THEN set headers
                const token = AuthHelper.getToken();
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }

                // FINALLY send data
                xhr.send(formData);
            });

            progressStatus.textContent = '‚úì Success';
            progressFill.style.width = '100%';
            progressFill.classList.add('success');
            results.push({success: true, file: file.name, id: result.artifact_id});

        } catch (error) {
            progressStatus.textContent = '‚úó Error: ' + error.message;
            progressFill.classList.add('error');
            results.push({success: false, file: file.name, error: error.message});
        }
    }

    // Show summary
    const successful = results.filter(r => r.success).length;
    const failed = results.filter(r => !r.success).length;

    alert(`Upload complete!\n‚úì Successful: ${successful}\n‚úó Failed: ${failed}`);

    clearFiles();
    fileWeights = {};  // Reset weights

    // Refresh recent uploads
    setTimeout(() => {
        window.location.href = '/web/artifacts';
    }, 1000);
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// Savignano-specific functions
function toggleSavignanoOptions() {
    const enabled = document.getElementById('enable-savignano').checked;
    document.getElementById('savignano-options').style.display = enabled ? 'block' : 'none';
}

function updateWeightMode() {
    const mode = document.querySelector('input[name="weight-mode"]:checked').value;
    document.getElementById('weight-file-input').style.display = mode === 'file' ? 'block' : 'none';
    document.getElementById('manual-weight-hint').style.display = mode === 'manual' ? 'block' : 'none';
    updateFileList();  // Refresh file list to show/hide weight inputs
}

function updateWeight(filename, weight) {
    if (weight && weight > 0) {
        fileWeights[filename] = parseFloat(weight);
    } else {
        delete fileWeights[filename];
    }
}

// Load projects on page load
async function loadProjects() {
    try {
        const response = await AuthHelper.fetch('/web/projects');
        const data = await response.json();

        if (response.ok && data.projects) {
            const select = document.getElementById('project-select');
            data.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.project_id;
                option.textContent = `${project.project_name || project.name} (${project.stats?.total_artifacts || 0} artifacts)`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Failed to load projects:', error);
    }
}

// Create new project dialog
async function showCreateProjectDialog() {
    const projectId = prompt('Enter Project ID (e.g., "bronzeaxes2025"):');
    if (!projectId) return;

    const projectName = prompt('Enter Project Name:');
    if (!projectName) return;

    const description = prompt('Enter Project Description (optional):') || '';

    try {
        const response = await AuthHelper.fetch('/web/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                project_id: projectId,
                name: projectName,
                description: description
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`‚úì Project "${projectName}" created successfully!`);
            // Reload projects
            document.getElementById('project-select').innerHTML = '<option value="">-- No Project (General Upload) --</option>';
            await loadProjects();
            // Select the new project
            document.getElementById('project-select').value = projectId;
        } else {
            alert(`‚úó Failed to create project: ${data.error || 'Unknown error'}`);
        }
    } catch (error) {
        alert(`‚úó Error: ${error.message}`);
    }
}

// Load projects when page loads
document.addEventListener('DOMContentLoaded', () => {
    loadProjects();
});
</script>
{% endblock %}
